<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>phasma - group chat</title>
  <link rel="icon" type="image/png" href="/static/icon.png">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: black;
      color: #fff;
      font: 16px/1.6 menlo, monospace;
      height: 100vh;
    }
    
    .chat-wrapper {
      max-width: 500px;
      margin: auto;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .chat-header {
      background: #0a1a0a;
      border-bottom: 1px solid #0f0;
      padding: 1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-header-left h3 {
      margin: 0;
      color: #0f0;
      font-size: 16px;
    }
    
    .chat-user-badge {
      font-size: 12px;
      color: #0ff;
      margin-top: 0.3em;
      text-transform: uppercase;
    }
    
    #out {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 1em;
      white-space: pre-wrap;
      position: relative;
    }
    
    #messages-container {
      display: flex;
      flex-direction: column;
    }
    
    #load-more-container {
      text-align: center;
      padding: 0.5em;
      background: rgba(0, 0, 0, 1);
      border-bottom: 0px solid #333;
      display: none;
      position: sticky;
      top: -20px;
      z-index: 100;
    }
    
    #load-more-btn {
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 0.5em 1em;
      font: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #load-more-btn:hover {
      background: #0f0;
      color: #000;
    }
    
    #load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      color: #888;
      border-color: #888;
    }
    
    #input-container {
      padding: 1em;
      border-top: 1px solid #333;
      background: #111;
    }
    
    input[type="text"] {
      width: 95%;
      padding: 0.5em;
      font: inherit;
      background: #222;
      color: #fff;
      border: none;
      outline: none;
    }
    
    #upload-btn {
      width: 48%;
      margin-top: 0.5em;
      background: #222;
      color: #fff;
      border: none;
      padding: 0.5em;
      font: inherit;
      cursor: pointer;
    }
    
    #upload-btn:hover {
      background: #333;
    }
    
    #file-input {
      display: none;
    }
    
    #leave-btn {
      background: #500;
      color: #fff;
      border: 1px solid #a00;
      padding: 0.5em 0.8em;
      font: inherit;
      cursor: pointer;
      transition: all 0.2s;
      position: fixed;
      top: 0;
      right: 0;
      z-index: 10000;
      margin: 0;
    }
    
    #leave-btn:hover {
      background: #a00;
    }
    
    .message {
      margin-bottom: 0.5em;
    }
    
    .message-header {
      font-size: 11px;
      color: #888;
      margin-bottom: 2px;
    }
    
    .message-content {
      color: #fff;
      white-space: normal;
      word-wrap: break-word;
    }
    
    .message-text {
      color: #fff;
      margin-bottom: 0.5em;
    }
    
    .url-previews {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      margin-top: 0.5em;
    }
    
    .url-preview-card {
      border: 1px solid #0ff;
      border-left: 3px solid #0ff;
      padding: 0.7em;
      background: #0a1a1a;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .url-preview-card:hover {
      background: #0d2a2a;
      border-left-color: #0ff;
    }
    
    .url-preview-service {
      font-size: 12px;
      color: #0ff;
      text-transform: uppercase;
      font-weight: bold;
      margin-bottom: 0.3em;
    }
    
    .url-preview-url {
      font-size: 12px;
      color: #0ff;
      margin-bottom: 0.3em;
      word-break: break-all;
      text-decoration: none;
      display: block;
    }
    
    .url-preview-title {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 0.3em;
      font-weight: bold;
    }
    
    .url-preview-description {
      font-size: 12px;
      color: #888;
      margin-bottom: 0.5em;
    }
    
    .url-preview-thumbnail {
      max-width: 100%;
      max-height: 200px;
      display: block;
      border: 1px solid #0ff;
      margin-bottom: 0.3em;
    }
    
    .photo-msg {
      color: #0f0;
    }
    
    .photo-msg img {
      max-width: 300px;
      margin-top: 0.5em;
      border: 1px solid #0f0;
      cursor: pointer;
      display: block;
    }

    .video-msg {
      color: #0ff;
      margin-top: 0.5em;
    }

    .video-player {
      max-width: 100%;
      max-height: 400px;
      background: #000;
      border-radius: 4px;
      border: 1px solid #0ff;
      margin-top: 0.5em;
      display: block;
    }

    .audio-msg {
      color: #70FFA9;
      margin-top: 0.5em;
      font-weight: bold;
    }

    .audio-player {
      width: 100%;
      max-width: 280px;
      height: 32px;
      margin-top: 0.5em;
      border: 2px solid #70FFA9;
      border-radius: 2px;
      background: linear-gradient(to bottom, #2a2a00, #1a1a00);
      font-family: menlo, monospace;
      cursor: pointer;
    }

    .audio-player:hover {
      border-color: #ffff00;
      box-shadow: 0 0 8px rgba(255, 255, 0, 0.4);
    }
    
    .file-msg {
      color: #0ff;
      margin-top: 0.5em;
    }
    
    .file-attachment {
      display: flex;
      align-items: center;
      gap: 0.5em;
      padding: 0.5em;
      background: #1a1a1a;
      border: 1px solid #0ff;
      margin-top: 0.3em;
      position: relative;
    }
    
    .file-icon {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      object-fit: contain;
    }
    
    .file-info {
      flex: 1;
      min-width: 0;
    }
    
    .file-name {
      color: #0ff;
      word-break: break-all;
      font-size: 14px;
    }
    
    .file-download-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #0ff;
      color: #000;
      border: none;
      padding: 4px 8px;
      font: 14px monospace;
      cursor: pointer;
      font-weight: bold;
      line-height: 1;
    }
    
    .file-download-btn:hover {
      background: #0aa;
    }
    
    .file-loading, .photo-loading {
      color: #888;
      font-style: italic;
    }
  </style>
</head>
<body>
  <button id="leave-btn">â†¤ Leave Group</button>
  
  <div class="chat-wrapper">
    <div class="chat-header">
      <div class="chat-header-left">
        <h3 id="group-name">Loading...</h3>
        <div class="chat-user-badge">ðŸ“¤ <span id="chat-user">...</span></div>
      </div>
    </div>

    <div id="out">
      <div id="load-more-container">
        <button id="load-more-btn">â†“ Load older messages</button>
      </div>
      <div id="messages-container"></div>
    </div>

    <div id="input-container">
      <b>Sending as: <span id="input-user">...</span></b><br>
      Message: <input type="text" id="in" autocomplete="off" />
      <button id="upload-btn">+ upload file</button>
      
      <input id="file-input" type="file" accept="image/jpeg,image/png,image/gif,image/webp,video/mp4,video/quicktime,video/webm,audio/mpeg,audio/mp4,audio/ogg,audio/wav,application/pdf,text/plain" />
    </div>
  </div>

  <script nonce="{{ nonce }}">
    const GROUP_ID = {{ group_id|tojson }};
    const TEMPLATE_USER = {{ user|tojson }};
    const TEMPLATE_GROUP_TOKEN = {{ auth_token|tojson }};
    const GROUP_NAME = {{ group_name|tojson }};
    
    let AUTH_TOKEN = null;
    let CURRENT_USER = null;
    let GROUP_SESSION_TOKEN = null;
    
    console.log('[Init] Group chat page loaded. Group ID:', GROUP_ID);
    console.log('[Init] Template user:', TEMPLATE_USER);
    console.log('[Init] Template group token:', TEMPLATE_GROUP_TOKEN ? TEMPLATE_GROUP_TOKEN.substring(0, 20) + '...' : 'NONE');
    
    // ========== Ð˜ÐÐ˜Ð¦Ð˜ÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯ ==========
    function initChat() {
      console.log('[Auth] Initializing chat authentication...');
      
      AUTH_TOKEN = localStorage.getItem('auth_token');
      CURRENT_USER = localStorage.getItem('username');
      
      console.log('[Auth] Auth token:', AUTH_TOKEN ? AUTH_TOKEN.substring(0, 20) + '...' : 'NONE');
      console.log('[Auth] Current user:', CURRENT_USER);
      
      if (!AUTH_TOKEN || !CURRENT_USER) {
        console.error('[Security] No auth token or username in localStorage');
        alert('Session lost. Please login again.');
        window.location.href = '/login';
        return false;
      }
      
      if (TEMPLATE_USER && TEMPLATE_USER !== CURRENT_USER) {
        console.error('[Security] Template user mismatch!');
        console.error('[Security] Template:', TEMPLATE_USER, 'Current:', CURRENT_USER);
        alert('SECURITY ERROR: User verification failed. Logging you out.');
        logout();
        return false;
      }
      
      if (TEMPLATE_GROUP_TOKEN) {
        console.log('[Auth] Using group token from template');
        GROUP_SESSION_TOKEN = TEMPLATE_GROUP_TOKEN;
        localStorage.setItem(`group_session_${GROUP_ID}`, GROUP_SESSION_TOKEN);
        console.log('[Auth] Group session token saved from template');
      } else {
        console.log('[Auth] No token in template, trying localStorage...');
        GROUP_SESSION_TOKEN = localStorage.getItem(`group_session_${GROUP_ID}`) ||
                             localStorage.getItem('current_group_token') ||
                             localStorage.getItem(`group_token_${GROUP_ID}`);
        
        if (!GROUP_SESSION_TOKEN) {
          console.log('[Auth] No group session token found. Requesting from server...');
          return requestGroupSession();
        }
      }
      
      console.log('[Auth] Group session token ready:', GROUP_SESSION_TOKEN.substring(0, 20) + '...');
      setupChat();
      return true;
    }

    function setupChat() {
      console.log('[Setup] Setting up chat interface...');
      
      document.getElementById('chat-user').textContent = CURRENT_USER;
      document.getElementById('input-user').textContent = CURRENT_USER;
      document.getElementById('group-name').textContent = GROUP_NAME;
      
      console.log('[Setup] Chat interface ready');
    }

    function handleSessionExpired() {
      console.error('[Session] Session expired');
      alert('Your session has expired. Please login again.');
      localStorage.removeItem('auth_token');
      localStorage.removeItem('username');
      localStorage.removeItem(`group_session_${GROUP_ID}`);
      window.location.href = '/login';
    }

    function getCurrentUser() {
      const stored = localStorage.getItem('username');
      if (!stored || stored !== CURRENT_USER) {
        console.error('[Security] User mismatch detected');
        handleSessionExpired();
        return null;
      }
      return CURRENT_USER;
    }

    // ========== Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ Ð ÐÐ‘ÐžÐ¢Ð« Ð¡Ðž Ð’Ð Ð•ÐœÐ•ÐÐ•Ðœ ==========
    function formatLocalTime(timestamp) {
      try {
        const ts = typeof timestamp === 'string' ? parseInt(timestamp, 10) : timestamp;
        const now = Math.floor(Date.now() / 1000);
        if (ts > now + 86400) {
          console.warn("[WARN] Suspicious timestamp:", ts, "current:", now);
        }
        const date = new Date(ts * 1000);
        if (isNaN(date.getTime())) {
          console.error("[ERROR] Invalid date from timestamp:", timestamp);
          return "??:??:??";
        }
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      } catch (e) {
        console.error("[ERROR] formatLocalTime failed:", e, timestamp);
        return "??:??:??";
      }
    }

    function formatLocalDate() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateFromTimestamp(timestamp) {
      try {
        const ts = typeof timestamp === 'string' ? parseInt(timestamp, 10) : timestamp;
        const date = new Date(ts * 1000);
        if (isNaN(date.getTime())) {
          return formatLocalDate();
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      } catch (e) {
        return formatLocalDate();
      }
    }

    let loadedMessageIds = new Set();
    let oldestMessageId = null;
    let newestMessageId = null;
    let isLoadingHistory = false;
    let hasMoreHistory = true;
    let initialLoadDone = false;
    let sseStarted = false;

    const out = document.getElementById("out");
    const messagesContainer = document.getElementById("messages-container");
    const loadMoreBtn = document.getElementById("load-more-btn");
    const loadMoreContainer = document.getElementById("load-more-container");

    // ========== ÐŸÐ ÐžÐ’Ð•Ð ÐšÐ Ð¡Ð•Ð¡Ð¡Ð˜Ð˜ ==========
    let sessionCheckFailed = 0;
    
    function checkSessionValidity() {
      const user = getCurrentUser();
      if (!user) return;

      fetch("/verify-session", {
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` }
      }).then(response => {
        if (response.status === 401) {
          console.error("[Session] Session expired");
          handleSessionExpired();
          return;
        }
        return response.json();
      }).then(data => {
        if (!data) {
          sessionCheckFailed++;
          if (sessionCheckFailed > 3) {
            console.error("[Session] Too many check failures");
            handleSessionExpired();
          }
          return;
        }
        
        sessionCheckFailed = 0;
        
        if (data.valid && data.type === 'group' && data.group_id !== GROUP_ID) {
            console.warn("[Session] Session is valid but for wrong group");
            window.location.href = "/groups";
        } else if (!data.valid) {
            console.error("[Session] Session no longer valid");
            handleSessionExpired();
        } else if (data.valid) {
            console.log("[Session] âœ“ Session valid");
        }
      }).catch(err => {
        console.warn("[Session] Check failed:", err);
        sessionCheckFailed++;
      });
    }

    setInterval(checkSessionValidity, 15000);

    function parseMessageData(data) {
      const timeMatch = data.match(/^\[(\d+)\]\s+/);
      if (!timeMatch) {
        console.warn("[WARN] Could not match timestamp in:", data.substring(0, 80));
        return null;
      }
      const timestamp = parseInt(timeMatch[1], 10);
      const afterTime = data.substring(timeMatch[0].length);
      
      const userMatch = afterTime.match(/^([^:]+):\s*/);
      if (!userMatch) {
        console.warn("[WARN] Could not match username in:", afterTime.substring(0, 80));
        return null;
      }
      
      const username = userMatch[1];
      const rest = afterTime.substring(userMatch[0].length);
      
      const urlsSplit = rest.split('|URLS:');
      const content = urlsSplit[0];
      let urls = {};
      
      if (urlsSplit.length > 1) {
        try {
          urls = JSON.parse(urlsSplit[1]);
        } catch (e) {
          urls = {};
        }
      }
      
      return {
        timestamp: timestamp,
        username: username,
        content: content,
        urls: urls
      };
    }

    function createURLPreviewCard(url, preview) {
      const card = document.createElement("div");
      card.className = "url-preview-card";
      
      const serviceDiv = document.createElement("div");
      serviceDiv.className = "url-preview-service";
      serviceDiv.textContent = preview.service_type || 'LINK';
      card.appendChild(serviceDiv);
      
      const urlDiv = document.createElement("div");
      urlDiv.className = "url-preview-url";
      urlDiv.style.cursor = 'pointer';
      urlDiv.textContent = url.substring(0, 60) + (url.length > 60 ? '...' : '');
      card.appendChild(urlDiv);
      
      if (preview.title) {
        const titleDiv = document.createElement("div");
        titleDiv.className = "url-preview-title";
        titleDiv.textContent = preview.title;
        card.appendChild(titleDiv);
      }
      
      if (preview.description) {
        const descDiv = document.createElement("div");
        descDiv.className = "url-preview-description";
        descDiv.textContent = preview.description.substring(0, 100) + (preview.description.length > 100 ? '...' : '');
        card.appendChild(descDiv);
      }
      
      if (preview.thumbnail_url) {
        const img = document.createElement("img");
        img.className = "url-preview-thumbnail";
        img.src = preview.thumbnail_url;
        img.alt = "Preview";
        img.loading = "lazy";
        img.onerror = () => img.style.display = 'none';
        img.onclick = (e) => {
          e.stopPropagation(); 
          window.open(url, '_blank');
        };
        card.appendChild(img);
      }
      
      card.onclick = () => window.open(url, '_blank');
      
      return card;
    }

    function createMessageElement(data) {
      const parsed = parseMessageData(data);
      if (!parsed) {
        console.error("[ERROR] Failed to parse message:", data.substring(0, 100));
        const msg = document.createElement("div");
        msg.className = "message";
        msg.textContent = "[PARSE ERROR] " + data;
        return msg;
      }
      
      const msgWrapper = document.createElement("div");
      msgWrapper.className = "message";
      
      const localTime = formatLocalTime(parsed.timestamp);
      const localDate = formatDateFromTimestamp(parsed.timestamp);
      
      const header = document.createElement("div");
      header.className = "message-header";
      header.textContent = `${localDate}, [${localTime}]`;
      msgWrapper.appendChild(header);
      
      const mainContent = document.createElement("div");
      mainContent.className = "message-content";
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ AUDIO ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ [AUDIO:file_id:url]
      if (parsed.content.startsWith("[AUDIO:")) {
        const audioMatch = parsed.content.match(/^\[AUDIO:(\d+):(.+)\]$/);
        if (audioMatch) {
          const fileId = audioMatch[1];
          const url = audioMatch[2];
          
          const audioDiv = document.createElement("div");
          audioDiv.className = "audio-msg";
          audioDiv.textContent = `${parsed.username}: `;
          
          const audio = document.createElement("audio");
          audio.className = "audio-player";
          audio.src = url;
          audio.controls = true;
          audio.preload = "metadata";
          
          audioDiv.appendChild(audio);
          mainContent.appendChild(audioDiv);
        }
      }
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ VIDEO ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ [VIDEO:file_id:url]
      else if (parsed.content.startsWith("[VIDEO:")) {
        const videoMatch = parsed.content.match(/^\[VIDEO:(\d+):(.+)\]$/);
        if (videoMatch) {
          const fileId = videoMatch[1];
          const url = videoMatch[2];
          
          const videoDiv = document.createElement("div");
          videoDiv.className = "video-msg";
          videoDiv.textContent = `${parsed.username}: `;
          
          const video = document.createElement("video");
          video.className = "video-player";
          video.src = url;
          video.controls = true;
          
          videoDiv.appendChild(video);
          mainContent.appendChild(videoDiv);
        }
      }
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ PHOTO ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ [PHOTO:file_id:url]
      else if (parsed.content.startsWith("[PHOTO:")) {
        const photoMatch = parsed.content.match(/^\[PHOTO:(\d+):(.+)\]$/);
        if (photoMatch) {
          const fileId = photoMatch[1];
          const url = photoMatch[2];
          
          const photoDiv = document.createElement("div");
          photoDiv.className = "photo-msg";
          photoDiv.textContent = `${parsed.username}: `;
          
          const img = document.createElement("img");
          img.src = url;
          img.alt = "Photo";
          img.loading = "lazy";
          img.onerror = () => {
            img.style.display = 'none';
          };
          img.onclick = () => window.open(url, '_blank');
          
          photoDiv.appendChild(img);
          mainContent.appendChild(photoDiv);
        }
      }
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ FILE ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ [FILE:file_id:category:filename:url]
      else if (parsed.content.startsWith("[FILE:")) {
        const fileMatch = parsed.content.match(/^\[FILE:(\d+):([^:]+):(.+?):(.+)\]$/);
        if (fileMatch) {
          const fileId = fileMatch[1];
          const category = fileMatch[2];
          const filename = fileMatch[3];
          const url = fileMatch[4];
          
          const fileDiv = document.createElement("div");
          fileDiv.className = "file-msg";
          
          const fileAttachment = document.createElement("div");
          fileAttachment.className = "file-attachment";
          
          const fileIcon = document.createElement("img");
          fileIcon.className = "file-icon";
          fileIcon.src = "/static/phasma_file.png";
          fileIcon.alt = "File";
          
          const fileInfo = document.createElement("div");
          fileInfo.className = "file-info";
          const fileName = document.createElement("div");
          fileName.className = "file-name";
          fileName.textContent = `${parsed.username}: ${filename}`;
          fileInfo.appendChild(fileName);
          
          const downloadBtn = document.createElement("button");
          downloadBtn.className = "file-download-btn";
          downloadBtn.textContent = "â†“";
          downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
          };
          
          fileAttachment.appendChild(fileIcon);
          fileAttachment.appendChild(fileInfo);
          fileAttachment.appendChild(downloadBtn);
          
          fileDiv.appendChild(fileAttachment);
          mainContent.appendChild(fileDiv);
        }
      }
      // ÐžÐ±Ñ‹Ñ‡Ð½Ð¾Ðµ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
      else {
        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = `${parsed.username}: ${parsed.content}`;
        mainContent.appendChild(textDiv);
        
        if (parsed.urls && Object.keys(parsed.urls).length > 0) {
          const previewsContainer = document.createElement("div");
          previewsContainer.className = "url-previews";
          
          for (const [url, preview] of Object.entries(parsed.urls)) {
            const card = createURLPreviewCard(url, preview);
            previewsContainer.appendChild(card);
          }
          
          mainContent.appendChild(previewsContainer);
        }
      }
      
      msgWrapper.appendChild(mainContent);
      
      return msgWrapper;
    }

    function loadHistory() {
      const user = getCurrentUser();
      if (!user) return;

      if (isLoadingHistory || !hasMoreHistory) {
        return;
      }

      isLoadingHistory = true;
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = "Loading...";

      const scrollContainer = out;
      const oldScrollHeight = scrollContainer.scrollHeight;
      const oldScrollTop = scrollContainer.scrollTop;

      const url = oldestMessageId 
        ? `/group/${GROUP_ID}/history?before_id=${oldestMessageId}&limit=50`
        : `/group/${GROUP_ID}/history?limit=50`;

      fetch(url, {
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` }
      })
      .then(response => response.json())
      .then(data => {
        if (data.messages.length === 0) {
          hasMoreHistory = false;
          loadMoreBtn.textContent = "No more messages";
          setTimeout(() => {
            loadMoreContainer.style.display = "none";
          }, 2000);
          return;
        }

        console.log(`[History] Loaded ${data.messages.length} messages`);

        const messageElements = [];
        data.messages.forEach(msg => {
          if (!loadedMessageIds.has(msg.id)) {
            loadedMessageIds.add(msg.id);
            const msgElement = createMessageElement(msg.text);
            messageElements.push({element: msgElement, id: msg.id});
            
            if (!oldestMessageId || msg.id < oldestMessageId) {
              oldestMessageId = msg.id;
            }
            if (!newestMessageId || msg.id > newestMessageId) {
              newestMessageId = msg.id;
            }
          }
        });

        if (initialLoadDone) {
          for (let i = messageElements.length - 1; i >= 0; i--) {
            messagesContainer.insertBefore(messageElements[i].element, messagesContainer.firstChild);
          }
        } else {
          messageElements.forEach(item => {
            messagesContainer.appendChild(item.element);
          });
        }

        if (initialLoadDone) {
          requestAnimationFrame(() => {
            const newScrollHeight = scrollContainer.scrollHeight;
            scrollContainer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
          });
        }

        hasMoreHistory = data.has_more;
        
        if (!hasMoreHistory) {
          loadMoreBtn.textContent = "No more messages";
          setTimeout(() => {
            loadMoreContainer.style.display = "none";
          }, 2000);
        } else {
          loadMoreBtn.textContent = "â†“ Load older messages";
        }

        if (!initialLoadDone) {
          initialLoadDone = true;
          console.log("[Init] First history load complete. Scrolling to bottom...");
          
          requestAnimationFrame(() => {
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
            
            if (!sseStarted) {
              sseStarted = true;
              console.log("[Init] Starting SSE...");
              startSSE();
            }
          });
        }
      })
      .catch(err => {
        console.error("Failed to load history:", err);
        loadMoreBtn.textContent = "âš  Error - try again";
        hasMoreHistory = true;
      })
      .finally(() => {
        isLoadingHistory = false;
        loadMoreBtn.disabled = false;
      });
    }

    out.addEventListener('scroll', () => {
      if (out.scrollTop < 100 && hasMoreHistory && !isLoadingHistory) {
        loadMoreContainer.style.display = "block";
      } else if (out.scrollTop > 200) {
        loadMoreContainer.style.display = "none";
      }
    });

    loadMoreBtn.addEventListener('click', loadHistory);

    function startSSE() {
      console.log("[SSE] Connecting to event stream...");
      
      fetch(`/group/${GROUP_ID}/stream`, {
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` }
      }).then(response => {
        console.log("[SSE] Connected successfully");
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        function read() {
          reader.read().then(({ done, value }) => {
            if (done) {
              console.log("[SSE] Stream closed");
              return;
            }
            
            const text = decoder.decode(value, { stream: true });
            const lines = text.split('\n');
            
            lines.forEach(line => {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (!data) return;
                
                console.log("[SSE] New message:", data.substring(0, 50) + "...");
                
                const msgElement = createMessageElement(data);
                messagesContainer.appendChild(msgElement);
                
                const isNearBottom = out.scrollHeight - out.scrollTop - out.clientHeight < 150;
                if (isNearBottom) {
                  requestAnimationFrame(() => {
                    out.scrollTop = out.scrollHeight;
                  });
                }
              }
            });
            read();
          });
        }
        read();
      }).catch(err => {
        console.error("[SSE] Failed to connect:", err);
      });
    }

    document.getElementById("in").addEventListener('keyup', function (e) {
      const user = getCurrentUser();
      if (!user) return;

      if (e.keyCode === 13) {
        const text = this.value;
        if (!text.trim()) return;
        
        $.ajax({
          url: `/group/${GROUP_ID}/post`,
          type: "POST",
          headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
          data: { message: text },
          success: function() {
            console.log('[Chat] Message sent by', user);
          },
          error: function(xhr) {
            console.error('[Chat] Error:', xhr.status);
            if (xhr.status === 429) {
              alert("You are sending requests too quickly. Please try again later.");
            } else if (xhr.status === 401) {
              console.error('[Chat] Session expired');
              handleSessionExpired();
            } else if (xhr.status === 400) {
              try {
                const response = JSON.parse(xhr.responseText);
                if (response.error === "Message too long") {
                  alert(`Message too long! Maximum length is ${response.max_length} characters.`);
                }
              } catch(e) {
                alert("Invalid request.");
              }
            }
          }
        });
        this.value = "";
      }
    });

    document.getElementById("upload-btn").addEventListener('click', function () {
      const user = getCurrentUser();
      if (!user) return;
      document.getElementById("file-input").click();
    });

    document.getElementById("file-input").addEventListener('change', function () {
      const user = getCurrentUser();
      if (!user) return;

      const file = this.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      $.ajax({
        url: `/group/${GROUP_ID}/upload`,
        type: "POST",
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          console.log("File uploaded by", user, ":", response);
          document.getElementById("file-input").value = "";
        },
        error: function (xhr) {
          try {
            const response = JSON.parse(xhr.responseText);
            alert("Upload failed: " + (response.message || xhr.responseText));
          } catch(e) {
            alert("Upload failed: " + xhr.responseText);
          }
          document.getElementById("file-input").value = "";
        }
      });
    });

    document.getElementById("leave-btn").addEventListener('click', function() {
      const user = getCurrentUser();
      if (!user) return;

      if (confirm("Warning: If you leave this group, it will be removed from your personal account and you won't be able to access it anymore. Are you sure?")) {
        fetch(`/api/groups/${GROUP_ID}/leave`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` }
        }).then(response => {
          if (response.ok) {
            console.log('[Chat] User', user, 'left the group');
            alert("You have left the group.");
            window.location.href = "/groups";
          } else {
            alert("Failed to leave group.");
          }
        }).catch(err => {
          console.error("Leave group error:", err);
          alert("An error occurred.");
        });
      }
    });

    window.addEventListener('beforeunload', function () {
      fetch('/logout', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        keepalive: true
      });
    });

    // ========== INIT ==========
    console.log('[Init] Starting group chat...');
    if (initChat()) {
      console.log('[Init] Loading initial history...');
      loadHistory();
    }
  </script>
</body>
</html>
