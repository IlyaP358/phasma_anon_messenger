<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>phasma - group chat</title>
  <link rel="icon" type="image/png" href="/static/icon.png">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: black;
      color: #fff;
      font: 16px/1.6 menlo, monospace;
      height: 100vh;
      overflow: hidden;
    }
    
    .chat-wrapper {
      display: flex;
      flex-direction: row;
      height: 100vh;
    }
    
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .chat-header {
      background: #0a1a0a;
      border-bottom: 1px solid #0f0;
      padding: 1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-header-left h3 {
      margin: 0;
      color: #0f0;
      font-size: 16px;
    }
    
    .chat-user-badge {
      font-size: 12px;
      color: #0ff;
      margin-top: 0.3em;
      text-transform: uppercase;
    }
    
    #out {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 1em;
      white-space: pre-wrap;
      position: relative;
      max-width: 100%;
    }
    
    #messages-container {
      display: flex;
      flex-direction: column;
    }
    
    #load-more-container {
      text-align: center;
      padding: 0.5em;
      background: rgba(0, 0, 0, 1);
      border-bottom: 0px solid #333;
      display: none;
      position: sticky;
      top: -20px;
      z-index: 100;
    }
    
    #load-more-btn {
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 0.5em 1em;
      font: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #load-more-btn:hover {
      background: #0f0;
      color: #000;
    }
    
    #load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      color: #888;
      border-color: #888;
    }
    
    #input-container {
      padding: 1em;
      border-top: 1px solid #333;
      background: #111;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
    }

    #file-preview-container {
      display: none;
      background: #0a1a0a;
      border: 1px solid #0ff;
      border-radius: 4px;
      padding: 0.8em;
      gap: 0.8em;
      align-items: flex-start;
    }

    #file-preview-container.active {
      display: flex;
    }

    .preview-thumbnail {
      flex-shrink: 0;
      width: 80px;
      height: 80px;
      background: #222;
      border: 1px solid #0ff;
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-thumbnail img,
    .preview-thumbnail video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .preview-thumbnail .file-icon {
      width: 50px;
      height: 50px;
      opacity: 0.6;
    }

    .preview-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.3em;
    }

    .preview-filename {
      color: #0ff;
      font-size: 13px;
      font-weight: bold;
      word-break: break-word;
    }

    .preview-filesize {
      color: #888;
      font-size: 11px;
    }

    .preview-source {
      color: #0f0;
      font-size: 10px;
      text-transform: uppercase;
      font-weight: bold;
    }

    .preview-actions {
      flex-shrink: 0;
      display: flex;
      gap: 0.5em;
    }

    .preview-btn {
      background: #0a1a0a;
      color: #0ff;
      border: 1px solid #0ff;
      padding: 0.3em 0.6em;
      font: inherit;
      cursor: pointer;
      font-size: 11px;
      border-radius: 2px;
      transition: all 0.2s;
    }

    .preview-btn:hover {
      background: #0ff;
      color: #000;
    }

    .input-row {
      display: flex;
      gap: 0.5em;
      align-items: center;
    }

    #in {
      flex: 1;
      padding: 0.7em;
      font: inherit;
      background: #222;
      color: #fff;
      border: 1px solid #333;
      outline: none;
      border-radius: 4px;
      resize: none;
      max-height: 100px;
    }

    #in:focus {
      border-color: #0ff;
      box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
    }
    
    .input-button {
      background: #222;
      color: #fff;
      border: 1px solid #333;
      padding: 0.7em 1em;
      font: inherit;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.3em;
      font-size: 14px;
    }

    .input-button:hover {
      background: #333;
      border-color: #0ff;
    }

    #send-btn {
      background: #0f0;
      color: #000;
      border-color: #0f0;
      font-weight: bold;
      padding: 0.7em 1.2em;
    }

    #send-btn:hover {
      background: #0d0;
    }

    #send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    #upload-btn {
      padding: 0.7em 1em;
    }

    #file-input {
      display: none;
    }
    
    #leave-btn {
      background: #500;
      color: #fff;
      border: 1px solid #a00;
      padding: 0.5em 0.8em;
      font: inherit;
      cursor: pointer;
      transition: all 0.2s;
      position: fixed;
      top: 0;
      right: 220px;
      z-index: 10000;
      margin: 0;
    }
    
    #leave-btn:hover {
      background: #a00;
    }
    
    .message {
      margin-bottom: 0.5em;
      position: relative;
      transition: all 0.2s;
      padding: 0.3em 0.5em;
      border-radius: 2px;
    }

    .message:hover {
      background: rgba(0, 255, 0, 0.05);
    }

    .message-delete-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #a00;
      color: #fff;
      border: none;
      padding: 0.2em 0.5em;
      font-size: 12px;
      cursor: pointer;
      border-radius: 2px;
      opacity: 0;
      transition: opacity 0.2s, background 0.2s;
      z-index: 10;
    }

    .message:hover .message-delete-btn {
      opacity: 1;
    }

    .message-delete-btn:hover {
      background: #f00;
    }
    
    .message-header {
      font-size: 11px;
      color: #888;
      margin-bottom: 2px;
    }
    
    .message-content {
      color: #fff;
      white-space: normal;
      word-wrap: break-word;
    }
    
    .message-text {
      color: #fff;
      margin-bottom: 0.5em;
    }
    
    .url-previews {
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      margin-top: 0.5em;
    }
    
    .url-preview-card {
      border: 1px solid #0ff;
      border-left: 3px solid #0ff;
      padding: 0.7em;
      background: #0a1a1a;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .url-preview-card:hover {
      background: #0d2a2a;
      border-left-color: #0ff;
    }
    
    .url-preview-service {
      font-size: 12px;
      color: #0ff;
      text-transform: uppercase;
      font-weight: bold;
      margin-bottom: 0.3em;
    }
    
    .url-preview-url {
      font-size: 12px;
      color: #0ff;
      margin-bottom: 0.3em;
      word-break: break-all;
      text-decoration: none;
      display: block;
    }
    
    .url-preview-title {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 0.3em;
      font-weight: bold;
    }
    
    .url-preview-description {
      font-size: 12px;
      color: #888;
      margin-bottom: 0.5em;
    }
    
    .url-preview-thumbnail {
      max-width: 100%;
      max-height: 200px;
      display: block;
      border: 1px solid #0ff;
      margin-bottom: 0.3em;
    }
    
    .photo-msg {
      color: #0f0;
    }
    
    .photo-msg img {
      max-width: 300px;
      margin-top: 0.5em;
      border: 1px solid #0f0;
      cursor: pointer;
      display: block;
    }

    .video-msg {
      color: #0ff;
      margin-top: 0.5em;
    }

    .video-player {
      max-width: 100%;
      max-height: 400px;
      background: #000;
      border-radius: 4px;
      border: 1px solid #0ff;
      margin-top: 0.5em;
      display: block;
    }

    .audio-msg {
      color: #70FFA9;
      margin-top: 0.5em;
      font-weight: bold;
    }

    .audio-player {
      width: 100%;
      max-width: 280px;
      height: 32px;
      margin-top: 0.5em;
      border: 2px solid #70FFA9;
      border-radius: 2px;
      background: linear-gradient(to bottom, #2a2a00, #1a1a00);
      font-family: menlo, monospace;
      cursor: pointer;
    }

    .audio-player:hover {
      border-color: #426faa;
      box-shadow: 0 0 8px rgba(255, 255, 0, 0.4);
    }
    
    .file-msg {
      color: #0ff;
      margin-top: 0.5em;
    }
    
    .file-attachment {
      display: flex;
      align-items: center;
      gap: 0.5em;
      padding: 0.5em;
      background: #1a1a1a;
      border: 1px solid #0ff;
      margin-top: 0.3em;
      position: relative;
    }
    
    .file-icon {
      width: 32px;
      height: 32px;
      flex-shrink: 0;
      object-fit: contain;
    }
    
    .file-info {
      flex: 1;
      min-width: 0;
    }
    
    .file-name {
      color: #0ff;
      word-break: break-all;
      font-size: 14px;
    }
    
    .file-download-btn {
      position: absolute;
      top: 4px;
      right: 4px;
      background: #0ff;
      color: #000;
      border: none;
      padding: 4px 8px;
      font: 14px monospace;
      cursor: pointer;
      font-weight: bold;
      line-height: 1;
    }
    
    .file-download-btn:hover {
      background: #0aa;
    }

    .members-sidebar {
      width: 220px;
      background: #0a1a0a;
      border-left: 1px solid #0f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .members-header {
      background: #0a1a0a;
      border-bottom: 1px solid #0f0;
      padding: 0.8em;
      color: #0f0;
      font-size: 13px;
      font-weight: bold;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .members-count {
      color: #0ff;
      font-size: 11px;
      font-weight: normal;
    }

    #members-list {
      flex: 1;
      overflow-y: auto;
      padding: 0.5em;
    }

    .member-item {
      padding: 0.6em;
      margin-bottom: 0.3em;
      background: #111;
      border-left: 3px solid #333;
      cursor: default;
      transition: all 0.2s;
      font-size: 13px;
      word-break: break-word;
      white-space: normal;
    }

    .member-item.online {
      border-left-color: #0f0;
      background: #0a1a0a;
    }

    .member-item.offline {
      border-left-color: #444;
      background: #000;
      opacity: 0.7;
    }

    .member-item.creator {
      border-left-color: #0ff;
      background: #0a0a1a;
    }

    .member-online-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #0f0;
      margin-right: 0.4em;
    }

    .member-offline-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #666;
      margin-right: 0.4em;
    }

    .member-username {
      font-weight: bold;
    }

    .member-role {
      font-size: 10px;
      color: #0ff;
      margin-left: 0.3em;
      text-transform: uppercase;
    }

    .members-empty {
      color: #666;
      text-align: center;
      padding: 1em;
      font-size: 12px;
      font-style: italic;
    }

    #members-list::-webkit-scrollbar {
      width: 6px;
    }

    #members-list::-webkit-scrollbar-track {
      background: #000;
    }

    #members-list::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    #members-list::-webkit-scrollbar-thumb:hover {
      background: #0f0;
    }

    #out::-webkit-scrollbar {
      width: 6px;
    }

    #out::-webkit-scrollbar-track {
      background: #000;
    }

    #out::-webkit-scrollbar-thumb {
      background: #333;
      border-radius: 3px;
    }

    #out::-webkit-scrollbar-thumb:hover {
      background: #0f0;
    }

    #drag-drop-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px);
    }

    #drag-drop-overlay.active {
      display: flex;
    }

    .drag-drop-box {
      border: 4px dashed #0f0;
      padding: 3em;
      text-align: center;
      background: rgba(0, 20, 0, 0.8);
      border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      animation: dragPulse 0.6s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes dragPulse {
      0%, 100% {
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        border-color: #0f0;
      }
      50% {
        box-shadow: 0 0 40px rgba(0, 255, 0, 0.6);
        border-color: #0ff;
      }
    }

    .drag-drop-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1em;
      object-fit: contain;
      filter: drop-shadow(0 0 8px rgba(0, 255, 0, 0.5));
    }

    .drag-drop-text {
      color: #0f0;
      font-size: 24px;
      font-weight: bold;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin: 0;
    }

    #error-notification {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #005a00;
      color: #44ff44;
      padding: 1em;
      border: 2px solid #00a000;
      border-radius: 4px;
      max-width: 300px;
      z-index: 10001;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      word-break: break-word;
      animation: slideIn 0.3s ease-out;
    }

    #error-notification.active {
      display: block;
    }

    #error-notification.success {
      background: #005a00;
      color: #44ff44;
      border-color: #00a000;
    }

    #error-notification.error {
      background: #5a0000;
      color: #ff4444;
      border-color: #a00;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .message-deleted {
      opacity: 0.5;
      background: rgba(100, 0, 0, 0.1);
      color: #888;
    }

    .message-deleted .message-delete-btn {
      display: none;
    }

    /* ========== MODAL STYLES ========== */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 50000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-dialog {
      background: #0a1a0a;
      border: 2px solid #0f0;
      border-radius: 4px;
      padding: 2em;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .modal-title {
      color: #0f0;
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 1em;
      text-transform: uppercase;
    }

    .modal-message {
      color: #fff;
      margin-bottom: 1.5em;
      line-height: 1.6;
    }

    .modal-buttons {
      display: flex;
      gap: 1em;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 0.6em 1.2em;
      font: inherit;
      cursor: pointer;
      border-radius: 2px;
      border: 1px solid;
      transition: all 0.2s;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 12px;
    }

    .modal-btn-confirm {
      background: #a00;
      color: #fff;
      border-color: #f00;
    }

    .modal-btn-confirm:hover {
      background: #f00;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
    }

    .modal-btn-cancel {
      background: #222;
      color: #0f0;
      border-color: #0f0;
    }

    .modal-btn-cancel:hover {
      background: #0f0;
      color: #000;
    }
    
    .emoji-picker-modal {
      display: none;
      position: fixed;
      bottom: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: #111;
      border: 2px solid #0f0;
      border-radius: 8px;
      box-shadow: 0 0 0px rgba(0, 255, 0, 0.3);
      z-index: 5000;
    }

    .emoji-picker-modal.active {
      display: flex;
      flex-direction: column;
    }

    .emoji-picker-container {
      display: flex;
      flex-direction: column;
      width: 420px;
      max-height: 520px;
      background: #0a1a0a;
      border-radius: 6px;
      overflow: hidden;
    }

    .emoji-picker-header {
      display: flex;
      gap: 0.5em;
      align-items: center;
      padding: 0.8em;
      border-bottom: 1px solid #0f0;
      background: #0a1a0a;
      flex-shrink: 0;
    }

    .emoji-search {
      flex: 1;
      padding: 0.6em;
      background: #222;
      border: 1px solid #333;
      color: #fff;
      font: 13px monospace;
      border-radius: 4px;
      outline: none;
    }

    .emoji-search:focus {
      border-color: #0ff;
      box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
    }

    .emoji-close-btn {
      background: none;
      border: none;
      color: #0f0;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .emoji-close-btn:hover {
      color: #f00;
      transform: rotate(90deg);
    }

    .emoji-categories-tabs {
      display: flex;
      gap: 0.3em;
      padding: 0.5em;
      border-bottom: 1px solid #333;
      background: #111;
      overflow-x: auto;
      flex-shrink: 0;
    }

    .emoji-tab {
      background: #222;
      border: 1px solid #333;
      color: #fff;
      font-size: 16px;
      padding: 0.4em 0.6em;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      flex-shrink: 0;
      min-width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-tab:hover {
      background: #333;
      border-color: #0f0;
    }

    .emoji-tab.active {
      background: #0f0;
      color: #000;
      border-color: #0f0;
      font-weight: bold;
    }

    .emoji-picker-content {
      flex: 1;
      overflow-y: auto;
      padding: 0.8em;
      background: #111;
    }

    .emoji-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 0.4em;
    }

    .emoji-item {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      background: #0a1a0a;
      border: 1px solid #333;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .emoji-item:hover {
      background: #0d2a0d;
      border-color: #0f0;
      transform: scale(1.15);
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
    }

    .emoji-item:active {
      transform: scale(0.9);
    }

    .emoji-no-results {
      text-align: center;
      color: #666;
      padding: 2em 1em;
      font-style: italic;
      grid-column: 1 / -1;
    }

    @media (max-width: 768px) {
      .chat-wrapper {
        flex-direction: column;
      }

      .members-sidebar {
        width: 100%;
        height: 150px;
        border-left: none;
        border-top: 1px solid #0f0;
      }

      #leave-btn {
        right: auto;
        left: 0;
      }

      #file-preview-container {
        flex-wrap: wrap;
      }

      .preview-thumbnail {
        width: 60px;
        height: 60px;
      }

      .drag-drop-box {
        padding: 2em;
      }

      .drag-drop-icon {
        width: 60px;
        height: 60px;
      }

      .drag-drop-text {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div id="drag-drop-overlay">
    <div class="drag-drop-box">
      <img src="/static/phasma_file.png" alt="Upload" class="drag-drop-icon" />
      <p class="drag-drop-text">Upload File</p>
    </div>
  </div>

  <div id="error-notification"></div>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-title">‚ö†Ô∏è Delete Message</div>
      <div class="modal-message">Are you sure you want to delete this message?
This action cannot be undone.</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="modal-confirm">Delete</button>
      </div>
    </div>
  </div>

  <button id="leave-btn">‚Üê Leave Group</button>
  
  <div class="chat-wrapper">
    <div class="chat-main">
      <div class="chat-header">
        <div class="chat-header-left">
          <h3 id="group-name">Loading...</h3>
          <div class="chat-user-badge">Logged as: 
<span id="chat-user">...</span></div>
        </div>
      </div>

      <div id="out">
        <div id="load-more-container">
          <button id="load-more-btn">‚Üì Load older messages</button>
        </div>
        <div id="messages-container"></div>
      </div>

      <div id="input-container">
        <div id="file-preview-container">
          <div class="preview-thumbnail" id="preview-thumbnail">
    
            <img id="preview-img" style="display: none;"
 />
            <video id="preview-video" style="display: none;"></video>
            <img id="preview-file-icon" class="file-icon" style="display: none;"
 src="/static/phasma_file.png" />
          </div>
          <div class="preview-info">
            <div class="preview-source" id="preview-source"></div>
            <div class="preview-filename" id="preview-filename"></div>
            <div class="preview-filesize" id="preview-filesize"></div>
          </div>
          <div class="preview-actions">
            <button type="button" class="preview-btn" 
 id="preview-remove-btn">‚úï Remove</button>
          </div>
        </div>

        <div class="input-row">
          <input type="text" id="in" autocomplete="off" placeholder="Type a message" />
          <button type="button" class="input-button" id="upload-btn">+ File</button>
          <button type="button" class="input-button" id="emoji-btn">üòÇ</button>
          <button type="button" class="input-button" id="send-btn">‚Ü≥</button>
        </div>
        
        <input id="file-input" type="file" accept="image/jpeg,image/png,image/gif,image/webp,video/mp4,video/quicktime,video/webm,audio/mpeg,audio/mp4,audio/ogg,audio/wav,application/pdf,text/plain" 
 />
      </div>
    </div>

    <div class="members-sidebar">
      <div class="members-header">
        Members <span class="members-count" id="members-count">(0)</span>
      </div>
      <div id="members-list"></div>
    </div>
  </div>

  <div id="emoji-picker-modal" class="emoji-picker-modal">
    <div class="emoji-picker-container">
      <div class="emoji-picker-header">
        <input type="text" id="emoji-search" class="emoji-search" placeholder="Search emoji..." />
        <button type="button" class="emoji-close-btn" id="emoji-close-btn">x</button>
      </div>

      <div class="emoji-categories-tabs">
        <button type="button" class="emoji-tab active" data-category="frequent">‚è±Ô∏è</button>
        <button type="button" class="emoji-tab" data-category="smileys">:)</button>
        <button type="button" class="emoji-tab" data-category="people">hi</button>
        <button type="button" class="emoji-tab" data-category="nature">leaf</button>
        <button type="button" class="emoji-tab" data-category="food">food</button>
        <button type="button" class="emoji-tab" data-category="travel">car</button>
        <button type="button" class="emoji-tab" data-category="objects">bulb</button>
        <button type="button" class="emoji-tab" data-category="symbols">heart</button>
      </div>

      <div class="emoji-picker-content">
        <div id="emoji-grid" class="emoji-grid"></div>
      </div>
    </div>
  </div>

  <script nonce="{{ nonce }}" type="module">
    const GROUP_ID = {{ group_id|tojson }};
    const TEMPLATE_USER = {{ user|tojson }};
    const TEMPLATE_GROUP_TOKEN = {{ auth_token|tojson }};
    const GROUP_NAME = {{ group_name|tojson }};
    
    // ========== EMOJI LOGIC STARTS HERE ==========
    const EMOJI_DATA = {
      frequent: [],
      smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'ü•≤', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòå', 'üòî', 'üòë', 'üòê', 'üò∂', 'ü§ê', 'üòè', 'üòí', 'üôÅ', '‚òπÔ∏è', 'üò¨', 'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§Æ', 'ü§¢', 'ü§Æ', 'ü§Æ', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', '‚òπÔ∏è', 'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±', 'üòñ', 'üò£', 'üòû', 'üòì', 'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø', 'üíÄ', '‚ò†Ô∏è', 'üí©', 'ü§°', 'üëπ', 'üë∫', 'üëª', 'üëΩ', 'üëæ', 'ü§ñ', 'üò∫', 'üò∏', 'üòπ', 'üòª', 'üòº', 'üòΩ', 'üôÄ', 'üòø', 'üòæ'],
      people: ['üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§å', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü´∞', 'ü§ü', 'ü§ò', 'ü§ô', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå', 'üëê', 'ü§≤', 'ü§ù', 'ü§ú', 'ü§õ', 'ü¶æ', 'ü¶ø', 'üëÇ', 'üëÉ', 'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ', 'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'ü™±', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü™∞', 'üê¢', 'üêç', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶â', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêà', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶ó', 'ü•ö', 'üçÑ', 'üå±', 'üå≤', 'üå≥', 'üå¥', 'üåµ', 'üåæ', 'üåø', '‚òòÔ∏è', 'üçÄ', 'üéç', 'üéé', 'üéè', 'üéê', 'üéë', 'üçá', 'üçà', 'üçâ', 'üçä', 'üçã', 'üçå', 'üçç', 'ü•≠', 'üçé', 'üçè', 'üçê', 'üçë', 'üçí', 'üçì', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'üåΩ', 'üçö', 'üçô', 'üçö', 'üçõ', 'üçú', 'üçù', 'üç†', 'üç¢', 'üç£', 'üç§', 'üç•', 'üç°', 'üç¶', 'üçß', 'üç®', 'üç©', 'üç™', 'üéÇ', 'üç∞', 'üßÅ', 'üç´', 'üç¨', 'üç≠', 'üçÆ', 'üçØ'],
      nature: ['üåø', 'üçÄ', '‚òòÔ∏è', 'üéç', 'üéé', 'üå≤', 'üå≥', 'üå¥', 'üå±', 'üåæ', 'üíê', 'üå∑', 'üåπ', 'ü•Ä', 'üå∫', 'üåª', 'üåû', 'üåù', 'üåõ', 'üåú', 'üåö', 'üåï', 'üåñ', 'üåó', 'üåò', 'üåë', 'üåí', 'üåì', 'üåî', '‚≠ê', 'üåü', '‚ú®', '‚ö°', '‚òÑÔ∏è', 'üí•', 'üî•', 'üå™Ô∏è', 'üåà', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå•Ô∏è', '‚òÅÔ∏è', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üå¨Ô∏è', 'üí®', 'üíß', 'üí¶', '‚òî'],
      food: ['üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'üåΩ', 'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ', 'üåØ', 'ü•ó', 'ü•ò', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°', 'üçß', 'üç®', 'üç¶', 'üç∞', 'üéÇ', 'üßÅ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'üå∞', 'üçØ', 'ü•õ', 'ü•§', '‚òï', 'üçµ', 'üç∂', 'üçæ', 'üç∑', 'üç∏', 'üçπ', 'üç∫', 'üçª', 'ü•Ç', 'ü•É'],
      travel: ['‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üõ∞Ô∏è', 'üöÅ', 'üõ∂', '‚õµ', 'üö§', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üõ•Ô∏è', 'üõ©Ô∏è', '‚úàÔ∏è', 'üöÄ', 'üõ∏', 'üöÇ', 'üöÉ', 'üöÑ', 'üöÖ', 'üöÜ', 'üöá', 'üöà', 'üöâ', 'üöä', 'üöù', 'üöû', 'üöã', 'üöå', 'üöç', 'üöé', 'üöê', 'üöë', 'üöí', 'üöì', 'üöî', 'üöï', 'üöñ', 'üöó', 'üöò', 'üöô', 'üöö', 'üöõ', 'üöú', 'üèéÔ∏è', 'üèçÔ∏è', 'üõµ', 'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ∫', 'üö≤', 'üõ¥', 'üõπ', 'üõº', 'üöè', '‚õΩ', 'üö®', 'üö•', 'üö¶', 'üõë', 'üöß', '‚öì', '‚õµ', 'üö§', 'üõ≥Ô∏è', 'üõ•Ô∏è', 'üõ∂', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üõ∞Ô∏è', 'üöÅ', 'üóº', 'üóΩ', 'üóø', '‚õ©Ô∏è', 'üé°', 'üé¢', 'üé†', '‚õ≤', '‚õ∫', 'üèïÔ∏è', '‚õ∞Ô∏è', '‚õ±Ô∏è', 'üèñÔ∏è', 'üèùÔ∏è', 'üèúÔ∏è', 'üåã', '‚õ∞Ô∏è', 'üéì', 'üéí'],
      objects: ['‚öΩ', '‚öæ', 'ü•é', 'üéæ', 'üèÄ', 'üèê', 'üèà', 'üèâ', 'üé±', 'üé≥', 'üéØ', 'üé£', 'üéΩ', 'üéø', '‚õ∑Ô∏è', 'üõ∑', 'üõ∏', 'ü•å', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'üé∑', 'üé∫', 'üé∏', 'üéª', 'üé≤', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', 'üì°', 'üì¢', 'üì£', 'üìØ', 'üìª', 'üì∫', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìæ', 'üìø', 'üéÄ', 'üéÅ', 'üéóÔ∏è', 'üéüÔ∏è', 'üé´', 'üéñÔ∏è', 'üèÜ', 'üèÖ', 'ü•á', 'ü•à', 'ü•â', '‚≠ê', 'üåü', '‚ú®', '‚ö°', '‚òÑÔ∏è', 'üí•', 'üî•', 'üå™Ô∏è', 'üåà', '‚òÄÔ∏è', 'üå§Ô∏è', '‚õÖ', 'üå•Ô∏è', '‚òÅÔ∏è', 'üå¶Ô∏è', 'üåßÔ∏è', '‚õàÔ∏è', 'üå©Ô∏è', 'üå®Ô∏è', '‚ùÑÔ∏è', '‚òÉÔ∏è', '‚õÑ', 'üå¨Ô∏è', 'üí®', 'üíß', 'üí¶', '‚òî', 'üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë'],
      symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', 'üíå', 'üíú', 'üíõ', 'üíö', 'üíô', '‚ù§Ô∏è', 'üß°', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', 'üíå', 'üíÆ', 'üíØ', '‚úÖ', '‚ùå', '‚ùé', '‚úîÔ∏è', '‚úñÔ∏è', '‚ûï', '‚ûñ', '‚ûó', '‚ûò', '‚ûô', '‚ûö', '‚ûõ', '‚ûú', '‚ûù', '‚ûû', '‚ûü', '‚û†', '‚û°Ô∏è', '‚û¢', '‚û£', '‚û§', '‚û•', '‚û¶', '‚ûß', '‚û®', '‚û©', '‚û™', '‚û´', '‚û¨', '‚û≠', '‚ûÆ', '‚ûØ', 'üîö', 'üîô', 'üîõ', 'üîù', 'üîú', '‚úÖ', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', 'üü§', '‚ö´', '‚ö™', 'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', 'üü´']
    };

    let recentEmojis = [];

    function saveRecentEmoji(emoji) {
      recentEmojis = [emoji, ...recentEmojis.filter(e => e !== emoji)].slice(0, 10);
      try {
        localStorage.setItem('recentEmojis', JSON.stringify(recentEmojis));
      } catch (e) {
        console.warn('Could not save recent emojis');
      }
    }

    function loadRecentEmojis() {
      try {
        const stored = localStorage.getItem('recentEmojis');
        recentEmojis = stored ? JSON.parse(stored) : [];
      } catch (e) {
        recentEmojis = [];
      }
      EMOJI_DATA.frequent = recentEmojis.length > 0 ? recentEmojis : ['üòä', 'üòÇ', '‚ù§Ô∏è', 'üëç', 'üî•', 'üíØ', '‚ú®', 'üëå'];
    }

    loadRecentEmojis();

    const emojiBtn = document.getElementById('emoji-btn');
    const emojiModal = document.getElementById('emoji-picker-modal');
    const emojiCloseBtn = document.getElementById('emoji-close-btn');
    const emojiSearch = document.getElementById('emoji-search');
    const emojiGrid = document.getElementById('emoji-grid');
    const emojiTabs = document.querySelectorAll('.emoji-tab');

    let currentCategory = 'frequent';

    emojiBtn.addEventListener('click', () => {
      emojiModal.classList.add('active');
      renderEmojiGrid('frequent');
      emojiSearch.focus();
    });

    emojiCloseBtn.addEventListener('click', () => {
      emojiModal.classList.remove('active');
      emojiSearch.value = '';
    });

    document.addEventListener('click', (e) => {
      if (!emojiModal.contains(e.target) && e.target !== emojiBtn) {
        emojiModal.classList.remove('active');
      }
    });

    emojiTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        emojiTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentCategory = tab.dataset.category;
        emojiSearch.value = '';
        renderEmojiGrid(currentCategory);
      });
    });

    emojiSearch.addEventListener('input', () => {
      const query = emojiSearch.value.toLowerCase();
      if (!query) {
        renderEmojiGrid(currentCategory);
        return;
      }
      emojiTabs.forEach(t => t.classList.remove('active'));
      renderSearchResults(query);
    });

    function renderEmojiGrid(category) {
      const emojis = EMOJI_DATA[category] || [];
      emojiGrid.innerHTML = '';

      if (emojis.length === 0) {
        emojiGrid.innerHTML = '<div class="emoji-no-results">No emojis</div>';
        return;
      }

      emojis.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        item.addEventListener('click', () => {
          insertEmoji(emoji);
          saveRecentEmoji(emoji);
          loadRecentEmojis();
        });
        emojiGrid.appendChild(item);
      });
    }

    function renderSearchResults(query) {
      emojiGrid.innerHTML = '';
      const results = [];

      Object.values(EMOJI_DATA).forEach(emojis => {
        emojis.forEach(emoji => {
          if (!results.includes(emoji)) {
            results.push(emoji);
          }
        });
      });

      const filtered = results.slice(0, 100);

      if (filtered.length === 0) {
        emojiGrid.innerHTML = '<div class="emoji-no-results">No results</div>';
        return;
      }

      filtered.forEach(emoji => {
        const item = document.createElement('div');
        item.className = 'emoji-item';
        item.textContent = emoji;
        item.addEventListener('click', () => {
          insertEmoji(emoji);
          saveRecentEmoji(emoji);
          loadRecentEmojis();
        });
        emojiGrid.appendChild(item);
      });
    }

    function insertEmoji(emoji) {
      const input = document.getElementById('in');
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const text = input.value;

      input.value = text.substring(0, start) + emoji + text.substring(end);
      input.selectionStart = input.selectionEnd = start + emoji.length;
      input.focus();

      emojiModal.classList.remove('active');
    }

    renderEmojiGrid('frequent');
    // ========== EMOJI LOGIC ENDS HERE ==========

    // ========== CORE CHAT VARIABLES ==========
    let AUTH_TOKEN = null;
    let CURRENT_USER = null;
    let GROUP_SESSION_TOKEN = null;
    let MEMBERS_UPDATE_INTERVAL = null;
    let ONLINE_HEARTBEAT_INTERVAL = null;
    let isUnloading = false;
    let selectedFile = null;
    let isUploadingFile = false;
    let messageIdToElementMap = new Map();
    let pendingDeleteMessageId = null;
    
    console.log('[Init] Group chat page loaded. Group ID:', GROUP_ID);
    
    function showError(message, duration = 5000) {
      const notification = document.getElementById('error-notification');
      notification.textContent = message;
      notification.classList.add('active');
      notification.classList.remove('success');
      setTimeout(() => {
        notification.classList.remove('active');
      }, duration);
    }

    function showSuccess(message, duration = 3000) {
      const notification = document.getElementById('error-notification');
      notification.textContent = message;
      notification.classList.add('active');
      notification.classList.add('success');
      
      setTimeout(() => {
        notification.classList.remove('active');
      }, duration);
    }

    // ========== MODAL FUNCTIONS ==========
    function showDeleteConfirmModal(messageId) {
      pendingDeleteMessageId = messageId;
      const modal = document.getElementById('confirm-modal');
      modal.classList.add('active');
    }

    function hideDeleteConfirmModal() {
      const modal = document.getElementById('confirm-modal');
      modal.classList.remove('active');
      pendingDeleteMessageId = null;
    }

    document.getElementById('modal-cancel').addEventListener('click', hideDeleteConfirmModal);
    document.getElementById('modal-confirm').addEventListener('click', function() {
      if (pendingDeleteMessageId !== null) {
        executeDeleteMessage(pendingDeleteMessageId);
      }
      hideDeleteConfirmModal();
    });
    document.getElementById('confirm-modal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideDeleteConfirmModal();
      }
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideDeleteConfirmModal();
      }
    });

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ==========
    function initAuth() {
      console.log('[Init] Initializing authentication...');
      // ‚úÖ –ü–æ–ª—É—á–∞–µ–º username –∏–∑ localStorage (–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏ –ø—Ä–∏ –ª–æ–≥–∏–Ω–µ)
      CURRENT_USER = localStorage.getItem('username');
      console.log('[Auth] Current user:', CURRENT_USER);
      console.log('[Auth] Template user:', TEMPLATE_USER);
      
      if (!CURRENT_USER) {
        console.error('[Auth] No username in localStorage - redirecting to login');
        alert('Session lost. Please login again.');
        window.location.href = '/login';
        return false;
      }
      
      // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ username —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      if (TEMPLATE_USER && TEMPLATE_USER !== CURRENT_USER) {
        console.error('[Auth] User mismatch! Template:', TEMPLATE_USER, 'Local:', CURRENT_USER);
        alert('SECURITY ERROR: User verification failed. Logging you out.');
        localStorage.removeItem('username');
        window.location.href = '/login';
        return false;
      }
      
      // ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º group token, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä–æ–º –≤ —à–∞–±–ª–æ–Ω–µ
      // HttpOnly cookie –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å credentials: 'include'
      if (TEMPLATE_GROUP_TOKEN) {
        GROUP_SESSION_TOKEN = TEMPLATE_GROUP_TOKEN;
        console.log('[Auth] Using group session token from template');
      } else {
        console.error('[Auth] No group session token from server');
        alert('Session lost. Please login again.');
        window.location.href = '/login';
        return false;
      }
      
      setupChat();
      return true;
    }

    function setupChat() {
      console.log('[Chat] Setting up chat interface...');
      document.getElementById('chat-user').textContent = CURRENT_USER;
      document.getElementById('group-name').textContent = GROUP_NAME;
      loadMembers();
      MEMBERS_UPDATE_INTERVAL = setInterval(loadMembers, 10000);
      sendOnlineHeartbeat();
      ONLINE_HEARTBEAT_INTERVAL = setInterval(sendOnlineHeartbeat, 20000);
    }

    function handleSessionExpired() {
      console.error('[Auth] Session expired');
      isUnloading = true;
      clearInterval(MEMBERS_UPDATE_INTERVAL);
      clearInterval(ONLINE_HEARTBEAT_INTERVAL);
      showError('‚úó Your session has expired. Redirecting...');
      setTimeout(() => {
        localStorage.removeItem('username');
        window.location.href = '/login';
      }, 1500);
    }

    function getCurrentUser() {
      const stored = localStorage.getItem('username');
      if (!stored || stored !== CURRENT_USER) {
        console.error('[Auth] User mismatch in getCurrentUser()');
        handleSessionExpired();
        return null;
      }
      return CURRENT_USER;
    }

    // ========== MEMBERS MANAGEMENT ==========
    function loadMembers() {
      const user = getCurrentUser();
      if (!user) return;
      
      fetch(`/api/groups/${GROUP_ID}/members`, {
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        credentials: 'include'  // ‚úÖ HttpOnly cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
      })
      .then(response => {
        if (response.status === 401) {
          console.error('[Members] 401 - Session expired');
          handleSessionExpired();
          return null;
        }
        return response.json();
      })
      .then(data => {
        if (!data) return;
        renderMembers(data.members, data.total);
      })
      .catch(err => console.error('[Members] Failed:', err));
    }

    function renderMembers(members, total) {
      const membersList = document.getElementById('members-list');
      const membersCount = document.getElementById('members-count');
      membersCount.textContent = `(${total})`;

      if (!members || members.length === 0) {
        membersList.innerHTML = '<div class="members-empty">No members</div>';
        return;
      }

      let html = '';
      members.forEach(member => {
        const isOnline = member.is_online;
        const isCreator = member.role === 'creator';
        const isCurrentUser = member.username === CURRENT_USER;
        
        let className = 'member-item ';
        if (isCreator) className += 'creator ';
        className += isOnline ? 'online' : 'offline';

        const dot = isOnline 
          ? '<span class="member-online-dot"></span>' 
          : '<span class="member-offline-dot"></span>';
        
        const roleLabel = isCreator ? '<span class="member-role">üëë</span>' : '';
        const userLabel = isCurrentUser ? ' <span class="member-role">(you)</span>' : '';

        html += `
          <div class="${className}">
            ${dot}<span class="member-username">${escapeHtml(member.username)}</span>${userLabel}${roleLabel}
          </div>
        `;
      });
      membersList.innerHTML = html;
    }

    function sendOnlineHeartbeat() {
      const user = getCurrentUser();
      if (!user) return;
      
      fetch(`/api/groups/${GROUP_ID}/members/online`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        credentials: 'include'  // ‚úÖ HttpOnly cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
      }).catch(err => console.warn('[Online] Failed:', err));
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== TIME FORMATTING ==========
    function formatLocalTime(timestamp) {
      try {
        const ts = typeof timestamp === 'string' ?
          parseInt(timestamp, 10) : timestamp;
        const date = new Date(ts * 1000);
        if (isNaN(date.getTime())) return "??:??:??";
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      } catch (e) {
        return "??:??:??";
      }
    }

    function formatLocalDate() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function formatDateFromTimestamp(timestamp) {
      try {
        const ts = typeof timestamp === 'string' ?
          parseInt(timestamp, 10) : timestamp;
        const date = new Date(ts * 1000);
        if (isNaN(date.getTime())) return formatLocalDate();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      } catch (e) {
        return formatLocalDate();
      }
    }

    // ========== DELETE MESSAGE ==========
    function executeDeleteMessage(messageId) {
      const user = getCurrentUser();
      if (!user) return;

      $.ajax({
        url: `/group/${GROUP_ID}/message/${messageId}/delete`,
        type: 'POST',
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        success: function() {
          console.log('[Delete] Message deleted:', messageId);
          
          const msgElement = messageIdToElementMap.get(messageId);
          if (msgElement) {
            msgElement.classList.add('message-deleted');
            msgElement.innerHTML = '<div class="message-header">[deleted]</div>';
            messageIdToElementMap.delete(messageId);
          }
          
          showError('‚úì Message deleted', 2000);
        },
        error: function(xhr) {
          console.error('[Delete] Failed:', xhr.status);
          
          if (xhr.status === 401) {
            handleSessionExpired();
            return;
          }
          
          if (xhr.status === 403) {
            showError('‚úó You can only delete your own messages');
            return;
          }
          
          try {
            const response = JSON.parse(xhr.responseText);
            showError(`‚úó Delete failed: ${response.error}`);
          } catch(e) {
            showError('‚úó Failed to delete message');
          }
        }
      });
    }

    // ========== MESSAGE PARSING & RENDERING ==========
    function parseMessageData(data) {
      const timeMatch = data.match(/^\[(\d+)\]\s+/);
      if (!timeMatch) return null;
      const timestamp = parseInt(timeMatch[1], 10);
      const afterTime = data.substring(timeMatch[0].length);
      
      const userMatch = afterTime.match(/^([^:]+):\s*/);
      if (!userMatch) return null;
      
      const username = userMatch[1];
      const rest = afterTime.substring(userMatch[0].length);
      
      const urlsSplit = rest.split('|URLS:');
      const content = urlsSplit[0];
      let urls = {};
      
      if (urlsSplit.length > 1) {
        try {
          urls = JSON.parse(urlsSplit[1]);
        } catch (e) {
          urls = {};
        }
      }
      
      return { timestamp, username, content, urls };
    }

    function createURLPreviewCard(url, preview) {
      const card = document.createElement("div");
      card.className = "url-preview-card";
      const serviceDiv = document.createElement("div");
      serviceDiv.className = "url-preview-service";
      serviceDiv.textContent = preview.service_type || 'LINK';
      card.appendChild(serviceDiv);
      
      const urlDiv = document.createElement("div");
      urlDiv.className = "url-preview-url";
      urlDiv.style.cursor = 'pointer';
      urlDiv.textContent = url.substring(0, 60) + (url.length > 60 ? '...' : '');
      card.appendChild(urlDiv);
      if (preview.title) {
        const titleDiv = document.createElement("div");
        titleDiv.className = "url-preview-title";
        titleDiv.textContent = preview.title;
        card.appendChild(titleDiv);
      }
      
      if (preview.description) {
        const descDiv = document.createElement("div");
        descDiv.className = "url-preview-description";
        descDiv.textContent = preview.description.substring(0, 100);
        card.appendChild(descDiv);
      }
      
      if (preview.thumbnail_url) {
        const img = document.createElement("img");
        img.className = "url-preview-thumbnail";
        img.src = preview.thumbnail_url;
        img.alt = "Preview";
        img.loading = "lazy";
        img.onerror = () => img.style.display = 'none';
        img.onclick = (e) => { e.stopPropagation(); window.open(url, '_blank'); };
        card.appendChild(img);
      }
      
      card.onclick = () => window.open(url, '_blank');
      return card;
    }

    function createMessageElement(data, messageId) {
      const parsed = parseMessageData(data);
      if (!parsed) {
        const msg = document.createElement("div");
        msg.className = "message";
        msg.textContent = "[PARSE ERROR]";
        return msg;
      }
      
      const msgWrapper = document.createElement("div");
      msgWrapper.className = "message";
      msgWrapper.setAttribute('data-message-id', messageId);
      
      const localTime = formatLocalTime(parsed.timestamp);
      const localDate = formatDateFromTimestamp(parsed.timestamp);
      
      const header = document.createElement("div");
      header.className = "message-header";
      header.textContent = `${localDate}, [${localTime}]`;
      msgWrapper.appendChild(header);
      
      const mainContent = document.createElement("div");
      mainContent.className = "message-content";
      if (parsed.content.startsWith("[AUDIO:")) {
        const audioMatch = parsed.content.match(/^\[AUDIO:(\d+):(.+)\]$/);
        if (audioMatch) {
          const audioDiv = document.createElement("div");
          audioDiv.className = "audio-msg";
          audioDiv.textContent = `${parsed.username}: `;
          const audio = document.createElement("audio");
          audio.className = "audio-player";
          audio.src = audioMatch[2];
          audio.controls = true;
          audioDiv.appendChild(audio);
          mainContent.appendChild(audioDiv);
        }
      }
      else if (parsed.content.startsWith("[VIDEO:")) {
        const videoMatch = parsed.content.match(/^\[VIDEO:(\d+):(.+)\]$/);
        if (videoMatch) {
          const videoDiv = document.createElement("div");
          videoDiv.className = "video-msg";
          videoDiv.textContent = `${parsed.username}: `;
          const video = document.createElement("video");
          video.className = "video-player";
          video.src = videoMatch[2];
          video.controls = true;
          videoDiv.appendChild(video);
          mainContent.appendChild(videoDiv);
        }
      }
      else if (parsed.content.startsWith("[PHOTO:")) {
        const photoMatch = parsed.content.match(/^\[PHOTO:(\d+):(.+)\]$/);
        if (photoMatch) {
          const photoDiv = document.createElement("div");
          photoDiv.className = "photo-msg";
          photoDiv.textContent = `${parsed.username}: `;
          const img = document.createElement("img");
          img.src = photoMatch[2];
          img.alt = "Photo";
          img.loading = "lazy";
          img.style.cursor = "pointer";
          img.onclick = () => window.open(photoMatch[2], '_blank');
          photoDiv.appendChild(img);
          mainContent.appendChild(photoDiv);
        }
      }
      else if (parsed.content.startsWith("[FILE:")) {
        const fileMatch = parsed.content.match(/^\[FILE:(\d+):([^:]+):(.+?):(.+)\]$/);
        if (fileMatch) {
          const fileDiv = document.createElement("div");
          fileDiv.className = "file-msg";
          const fileAttachment = document.createElement("div");
          fileAttachment.className = "file-attachment";
          
          const fileIcon = document.createElement("img");
          fileIcon.className = "file-icon";
          fileIcon.src = "/static/phasma_file.png";
          const fileInfo = document.createElement("div");
          fileInfo.className = "file-info";
          const fileName = document.createElement("div");
          fileName.className = "file-name";
          fileName.textContent = `${parsed.username}: ${fileMatch[3]}`;
          fileInfo.appendChild(fileName);
          const downloadBtn = document.createElement("button");
          downloadBtn.className = "file-download-btn";
          downloadBtn.textContent = "‚¨á";
          downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = fileMatch[4];
            a.download = fileMatch[3];
            a.click();
          };
          
          fileAttachment.appendChild(fileIcon);
          fileAttachment.appendChild(fileInfo);
          fileAttachment.appendChild(downloadBtn);
          fileDiv.appendChild(fileAttachment);
          mainContent.appendChild(fileDiv);
        }
      }
      else {
        const textDiv = document.createElement("div");
        textDiv.className = "message-text";
        textDiv.textContent = `${parsed.username}: ${parsed.content}`;
        mainContent.appendChild(textDiv);
        
        if (parsed.urls && Object.keys(parsed.urls).length > 0) {
          const previewsContainer = document.createElement("div");
          previewsContainer.className = "url-previews";
          for (const [url, preview] of Object.entries(parsed.urls)) {
            previewsContainer.appendChild(createURLPreviewCard(url, preview));
          }
          mainContent.appendChild(previewsContainer);
        }
      }
      
      msgWrapper.appendChild(mainContent);
      // ‚úÖ DELETE BUTTON - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
      const isOwnMessage = parsed.username === CURRENT_USER;
      if (isOwnMessage) {
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "message-delete-btn";
        deleteBtn.textContent = "üóëÔ∏è delete";
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          showDeleteConfirmModal(messageId);
        };
        
        msgWrapper.appendChild(deleteBtn);
        messageIdToElementMap.set(messageId, msgWrapper);
      }
      
      return msgWrapper;
    }

    // ========== CHAT HISTORY & STREAMING ==========
    let loadedMessageIds = new Set();
    let oldestMessageId = null;
    let newestMessageId = null;
    let isLoadingHistory = false;
    let hasMoreHistory = true;
    let initialLoadDone = false;
    let sseStarted = false;

    const out = document.getElementById("out");
    const messagesContainer = document.getElementById("messages-container");
    const loadMoreBtn = document.getElementById("load-more-btn");
    const loadMoreContainer = document.getElementById("load-more-container");
    function loadHistory() {
      if (isLoadingHistory || !hasMoreHistory) return;
      isLoadingHistory = true;
      loadMoreBtn.disabled = true;
      loadMoreBtn.textContent = "Loading...";

      const scrollContainer = out;
      const oldScrollHeight = scrollContainer.scrollHeight;
      const oldScrollTop = scrollContainer.scrollTop;
      const url = oldestMessageId 
        ?
        `/group/${GROUP_ID}/history?before_id=${oldestMessageId}&limit=50`
        : `/group/${GROUP_ID}/history?limit=50`;
      fetch(url, {
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        credentials: 'include'  // ‚úÖ HttpOnly cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
      })
      .then(response => {
        if (response.status === 401) {
          handleSessionExpired();
          return null;
        }
        return response.json();
      })
      .then(data => {
        if (!data) return;
        if (data.messages.length === 0) {
          hasMoreHistory = false;
          loadMoreBtn.textContent = "No more messages";
          setTimeout(() => loadMoreContainer.style.display = "none", 2000);
          return;
        }

        const messageElements = [];
        data.messages.forEach(msg => {
          if (!loadedMessageIds.has(msg.id)) {
            loadedMessageIds.add(msg.id);
            const msgElement = createMessageElement(msg.text, msg.id);
            messageElements.push({element: msgElement, id: msg.id});
            
            if (!oldestMessageId || msg.id < oldestMessageId) {
              oldestMessageId = msg.id;
            }
            if (!newestMessageId || msg.id > newestMessageId) {
              newestMessageId = msg.id;
            }
          }
        });
        if (initialLoadDone) {
          for (let i = messageElements.length - 1; i >= 0; i--) {
            messagesContainer.insertBefore(messageElements[i].element, messagesContainer.firstChild);
          }
        } else {
          messageElements.forEach(item => messagesContainer.appendChild(item.element));
        }

        if (initialLoadDone) {
          requestAnimationFrame(() => {
            const newScrollHeight = scrollContainer.scrollHeight;
            scrollContainer.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);
          });
        }

        hasMoreHistory = data.has_more;
        if (!hasMoreHistory) {
          loadMoreBtn.textContent = "No more messages";
          setTimeout(() => loadMoreContainer.style.display = "none", 2000);
        } else {
          loadMoreBtn.textContent = "‚Üë Load older messages";
        }

        if (!initialLoadDone) {
          initialLoadDone = true;
          requestAnimationFrame(() => {
            scrollContainer.scrollTop = scrollContainer.scrollHeight;
            if (!sseStarted) {
              sseStarted = true;
              startSSE();
            }
          });
        }
      })
      .catch(err => {
        console.error("Failed to load history:", err);
        loadMoreBtn.textContent = "‚ö† Error - try again";
        hasMoreHistory = true;
      })
      .finally(() => {
        isLoadingHistory = false;
        loadMoreBtn.disabled = false;
      });
    }

    out.addEventListener('scroll', () => {
      if (out.scrollTop < 100 && hasMoreHistory && !isLoadingHistory) {
        loadMoreContainer.style.display = "block";
      } else if (out.scrollTop > 200) {
        loadMoreContainer.style.display = "none";
      }
    });
    loadMoreBtn.addEventListener('click', loadHistory);

    function startSSE() {
      fetch(`/group/${GROUP_ID}/stream`, {
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        credentials: 'include'  // ‚úÖ HttpOnly cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
      }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        function read() {
          reader.read().then(({ done, value }) => {
            if (done) return;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            
            buffer = lines.pop() 
              || '';
            
            lines.forEach(line => {
              if (line.startsWith('data: ')) {
                const data = line.slice(6).trim();
                if (!data) return;
                
                // ‚úÖ HANDLE DELETE MESSAGES
                if (data.startsWith('DELETE_MESSAGE:')) {
                  const messageId = parseInt(data.substring(15), 10);
                  console.log('[SSE] Message deleted:', messageId);
                  
                  const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
                  if (msgElement) {
                    msgElement.style.transition = 'all 0.3s ease-out';
                    msgElement.style.opacity = '0';
                    msgElement.style.height = '0';
                    msgElement.style.margin = '0';
                    msgElement.style.overflow = 'hidden';
                    setTimeout(() => {
                      msgElement.remove();
                      messageIdToElementMap.delete(messageId);
                    }, 300);
                  }
                  return;
                }
                
                const msgElement = createMessageElement(data, Date.now() + Math.random());
                messagesContainer.appendChild(msgElement);
                
                const isNearBottom = out.scrollHeight - out.scrollTop - out.clientHeight < 150;
                if (isNearBottom) {
                  requestAnimationFrame(() => {
                    out.scrollTop = out.scrollHeight;
                  });
                }
              }
            });
            read();
          });
        }
        read();
      }).catch(err => console.error("[SSE] Failed:", err));
    }

    // ========== SENDING MESSAGES & FILES ==========
    function sendMessageOrFile() {
      if (isUploadingFile) {
        showError('‚è≥ Upload in progress. Please wait...');
        return;
      }

      if (selectedFile) {
        sendFile();
        return;
      }

      const text = document.getElementById('in').value;
      if (!text.trim()) return;
      $.ajax({
        url: `/group/${GROUP_ID}/post`,
        type: 'POST',
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        data: { message: text },
        success: function() {
          document.getElementById('in').value = '';
        },
        error: function(xhr) {
          if (xhr.status === 429) {
             showError('‚úó You are sending requests too quickly. Try again later.');
          } else if (xhr.status === 401) {
            handleSessionExpired();
          } else if (xhr.status === 400) {
            try {
              const response = JSON.parse(xhr.responseText);
              if (response.error === 'Message too long') {
                showError(`‚úó Message too long! Maximum: ${response.max_length} characters.`);
              }
            } catch(e) {
              showError('‚úó Invalid request.');
            }
          } else {
            showError('‚úó Failed to send message.');
          }
        }
      });
    }

    async function sendFile() {
      if (!selectedFile) return;
      if (isUploadingFile) return;
      isUploadingFile = true;
      
      const formData = new FormData();
      formData.append('file', selectedFile);
      $.ajax({
        url: `/group/${GROUP_ID}/upload`,
        type: 'POST',
        headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
          console.log('[Upload] File sent successfully');
          hideFilePreview();
          isUploadingFile = false;
        },
        error: function(xhr) {
          isUploadingFile = false;
          try {
            const response = JSON.parse(xhr.responseText);
            const message = response.message || response.error || 'Unknown error';
            showError(`‚úó Upload failed: ${message}`);
          } catch(e) {
            if (xhr.status === 429) {
              showError('‚úó Too many requests. Try again later.');
            } else if (xhr.status === 401) {
              showError('‚úó Session expired. Please login again.');
              handleSessionExpired();
            } else if (xhr.status === 400) {
              showError('‚úó Invalid file. Please check the file and try again.');
            } else {
              showError(`‚úó Upload failed (${xhr.status})`);
            }
          }
        }
      });
    }

    document.getElementById('send-btn').addEventListener('click', sendMessageOrFile);
    document.getElementById('in').addEventListener('keyup', function(e) {
      if (e.keyCode === 13 && !e.shiftKey) {
        e.preventDefault();
        sendMessageOrFile();
      }
    });
    // ========== FILE HANDLING ==========
    const ALLOWED_EXTENSIONS = {
      'jpg': true, 'jpeg': true, 'png': true, 'gif': true, 'webp': true,
      'mp4': true, 'mov': true, 'webm': true,
      'mp3': true, 'm4a': true, 'ogg': true, 'wav': true,
      'pdf': true, 'txt': true
    };
    const MAX_FILE_SIZES = {
      'jpg': 10, 'jpeg': 10, 'png': 10, 'gif': 10, 'webp': 10,
      'mp4': 100, 'mov': 100, 'webm': 100,
      'mp3': 50, 'm4a': 50, 'ogg': 50, 'wav': 50,
      'pdf': 25, 'txt': 25
    };
    function getFileExtension(filename) {
      if (!filename || !filename.includes('.')) return '';
      return filename.split('.').pop().toLowerCase();
    }

    function validateFileExtension(ext) {
      return ALLOWED_EXTENSIONS[ext] === true;
    }

    function validateFileSize(file, ext) {
      const maxSizeMB = MAX_FILE_SIZES[ext] || 10;
      const maxSizeBytes = maxSizeMB * 1024 * 1024;
      return file.size <= maxSizeBytes;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function processFileUpload(file, source = 'upload') {
      const ext = getFileExtension(file.name);
      if (!validateFileExtension(ext)) {
        const allowedExts = Object.keys(ALLOWED_EXTENSIONS).join(', ');
        showError(`‚úó File format ".${ext}" not allowed. Allowed: ${allowedExts}`);
        return;
      }

      if (!validateFileSize(file, ext)) {
        const maxSize = MAX_FILE_SIZES[ext] ||
          10;
        showError(`‚úó File too large. Maximum size: ${maxSize}MB`);
        return;
      }

      if (file.size < 100) {
        showError('‚úó File is too small (minimum 100 bytes)');
        return;
      }

      showFilePreview(file, source);
    }

    function showFilePreview(file, source = 'upload') {
      selectedFile = file;
      const container = document.getElementById('file-preview-container');
      const filename = document.getElementById('preview-filename');
      const filesize = document.getElementById('preview-filesize');
      const sourceLabel = document.getElementById('preview-source');
      const previewImg = document.getElementById('preview-img');
      const previewVideo = document.getElementById('preview-video');
      const previewIcon = document.getElementById('preview-file-icon');

      previewImg.style.display = 'none';
      previewVideo.style.display = 'none';
      previewIcon.style.display = 'none';
      if (source === 'drag-drop') {
        sourceLabel.textContent = 'üì• Dropped';
      } else if (source === 'paste') {
        sourceLabel.textContent = 'üìã Pasted';
      } else {
        sourceLabel.textContent = 'üìÑ From Device';
      }
      
      filename.textContent = file.name;
      filesize.textContent = formatFileSize(file.size);
      const ext = getFileExtension(file.name);

      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else if (file.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewVideo.src = e.target.result;
          previewVideo.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewIcon.style.display = 'block';
      }

      container.classList.add('active');
      console.log('[Preview] File selected:', file.name, formatFileSize(file.size));
    }

    function hideFilePreview() {
      selectedFile = null;
      const container = document.getElementById('file-preview-container');
      container.classList.remove('active');
      document.getElementById('file-input').value = '';
    }

    document.getElementById('in').addEventListener('paste', function(e) {
      const items = e.clipboardData?.items;
      if (!items) return;

      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        
        if (item.kind === 'file') {
          const file = item.getAsFile();
          if (file) {
             e.preventDefault();
            processFileUpload(file, 'paste');
            break;
          }
        }
      }
    });
    document.getElementById('file-input').addEventListener('change', function() {
      if (this.files.length > 0) {
        processFileUpload(this.files[0], 'upload');
      }
    });
    document.getElementById('preview-remove-btn').addEventListener('click', hideFilePreview);
    document.getElementById('upload-btn').addEventListener('click', function() {
      document.getElementById('file-input').click();
    });
    // ========== DRAG & DROP ==========
    const dragDropOverlay = document.getElementById('drag-drop-overlay');
    let isDraggingFile = false;
    let dragLeaveTimeout = null;
    
    document.addEventListener('dragenter', (e) => {
      if (e.dataTransfer?.types?.includes('Files')) {
        clearTimeout(dragLeaveTimeout);
        isDraggingFile = true;
        dragDropOverlay.classList.add('active');
      }
    });
    document.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
      clearTimeout(dragLeaveTimeout);
    });
    document.addEventListener('dragleave', (e) => {
      dragLeaveTimeout = setTimeout(() => {
        isDraggingFile = false;
        dragDropOverlay.classList.remove('active');
      }, 50);
    });
    document.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      clearTimeout(dragLeaveTimeout);
      isDraggingFile = false;
      dragDropOverlay.classList.remove('active');
      
      const files = e.dataTransfer?.files;
      if (!files || files.length === 0) return;

      const file = files[0];
      processFileUpload(file, 'drag-drop');
    });
    // ========== LEAVE GROUP ==========
    document.getElementById("leave-btn").addEventListener('click', function() {
      if (confirm("Warning: If you leave this group, it will be removed from your personal account. Are you sure?")) {
        isUnloading = true;
        fetch(`/api/groups/${GROUP_ID}/leave`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${GROUP_SESSION_TOKEN}` },
          credentials: 'include'  // ‚úÖ HttpOnly cookie –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
        }).then(response => {
          if (response.ok) {
            clearInterval(MEMBERS_UPDATE_INTERVAL);
            clearInterval(ONLINE_HEARTBEAT_INTERVAL);
            alert("You have left the group.");
            window.location.href = "/groups";
          } else {
            alert("Failed to leave group.");
            isUnloading = false;
          }
        }).catch(err => {
          console.error("Leave group error:", err);
          alert("An error occurred.");
          isUnloading = false;
        });
      }
    });
    
    window.addEventListener('beforeunload', function() {
      if (!isUnloading) {
        clearInterval(MEMBERS_UPDATE_INTERVAL);
        clearInterval(ONLINE_HEARTBEAT_INTERVAL);
      }
    });
    // ========== INITIALIZATION ==========
    console.log('[Init] Starting group chat initialization...');
    if (initAuth()) {
      console.log('[Init] Auth successful, loading history...');
      loadHistory();
    } else {
      console.error('[Init] Auth failed');
    }
  </script>
</body>
</html>
