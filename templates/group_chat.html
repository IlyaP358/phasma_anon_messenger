<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Group Chat - phasma</title>
  <link rel="icon" type="image/png" href="/static/icon.png">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <link rel="stylesheet" href="/static/css/fluent.css">
  <link rel="stylesheet" href="/static/css/group_chat.css">
</head>

<body>
  <div id="drag-drop-overlay">
    <div class="drag-drop-box">
      <img src="/static/phasma_file.png" alt="Upload" class="drag-drop-icon" />
      <p class="drag-drop-text">Upload File</p>
    </div>
  </div>

  <div id="error-notification"></div>

  <div id="confirm-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-title">‚ö†Ô∏è Delete Message</div>
      <div class="modal-message">Are you sure you want to delete this message?
        This action cannot be undone.</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" id="modal-cancel">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="modal-confirm">Delete</button>
      </div>
    </div>
  </div>

  <div id="delete-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-title">Delete Group</div>
      <div class="modal-message">
        <div id="delete-error"></div>
        <p style="color: #ccc; margin-bottom: 1em;">
          ‚ö†Ô∏è This action cannot be undone. All messages and files will be permanently deleted.
        </p>
        <div style="margin-bottom: 1em;">
          <label style="display:block; color:#0f0; margin-bottom:0.5em; font-weight:bold;">Root Password</label>
          <input type="password" id="delete-password" placeholder="Enter root password"
            style="width:100%; padding:0.5em; background:#222; border:1px solid #333; color:#fff;">
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" id="btn-cancel-delete">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="btn-confirm-delete">Delete Group</button>
      </div>
    </div>
  </div>

  <div id="leave-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-title">‚ö†Ô∏è Leave Group</div>
      <div class="modal-message">
        <p style="color: #ccc; margin-bottom: 1em;">
          Warning: If you leave this group, it will be removed from your personal account. Are you sure?
        </p>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" id="btn-cancel-leave">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="btn-confirm-leave">Leave Group</button>
      </div>
    </div>
  </div>

  <div id="invite-modal" class="modal-overlay">
    <div class="modal-dialog" style="text-align: center;">
      <div class="modal-title">Invite to Group</div>
      <div class="modal-message">
        <div id="invite-loading" class="loading">Generating invite...</div>
        <div id="invite-content" style="display: none;">
          <img id="invite-qr" src="" alt="QR Code"
            style="width: 200px; height: 200px; margin: 10px auto; display: block; border: 5px solid white; border-radius: 10px;">
          <div style="margin-top: 15px;">
            <input type="text" id="invite-link" readonly
              style="width: 100%; padding: 8px; background: #222; border: 1px solid #333; color: #fff; border-radius: 4px; text-align: center;">
            <button class="modal-btn modal-btn-confirm" id="btn-copy-invite" style="margin-top: 10px; width: 100%;">Copy
              Link</button>
          </div>
          <p style="color: #888; font-size: 12px; margin-top: 10px;">Link expires in 1 hour</p>
        </div>
        <div id="invite-error" class="error"></div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" id="btn-close-invite">Close</button>
      </div>
    </div>
  </div>

  <div id="kick-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-title">Kick Member</div>
      <div class="modal-message">
        Are you sure you want to kick <strong id="kick-username"></strong> from the group?
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" id="btn-cancel-kick">Cancel</button>
        <button class="modal-btn modal-btn-confirm" id="btn-confirm-kick"
          style="background-color: #d13438;">Kick</button>
      </div>
    </div>
  </div>

  <div id="group-settings-modal" class="modal-overlay">
    <div class="modal-dialog">
      <div class="modal-title">Group Settings</div>
      <div class="modal-message">
        <div class="form-group" style="text-align: center;">
          <div class="profile-pic-container"
            style="margin: 0 auto 15px; width: 100px; height: 100px; border-radius: 50%; overflow: hidden; position: relative; border: 2px solid var(--primary-color); cursor: pointer;">
            <img id="group-avatar-preview" src="/group/avatar/{{ group_id }}" alt="Group Avatar"
              style="width: 100%; height: 100%; object-fit: cover;">
            <div class="profile-pic-overlay"
              style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s;">
              <span style="color: white; font-size: 12px;">Change</span>
              <input type="file" id="group-avatar-input" accept="image/*" hidden>
            </div>
          </div>
          <div style="font-size: 12px; color: #888;">Group Photo (Admin Only)</div>
        </div>
        <div class="form-group">
          <label style="display:block; margin-bottom:15px; font-weight: 500;">Group Type</label>
          <div class="group-type-options" style="display: flex; gap: 15px;">
            <label class="group-type-label" style="flex:1; cursor:pointer;">
              <input type="radio" name="settings-type" value="public" style="display: none;">
              <div class="group-type-card"
                style="border:2px solid #444; padding:20px; border-radius:8px; text-align:center; transition: all 0.2s; background: #1a1a1a;">
                <div class="group-type-icon" style="font-size: 32px; margin-bottom: 8px;">üåê</div>
                <div class="group-type-name" style="font-weight: 500;">Public</div>
              </div>
            </label>
            <label class="group-type-label" style="flex:1; cursor:pointer;">
              <input type="radio" name="settings-type" value="private" style="display: none;">
              <div class="group-type-card"
                style="border:2px solid #444; padding:20px; border-radius:8px; text-align:center; transition: all 0.2s; background: #1a1a1a;">
                <div class="group-type-icon" style="font-size: 32px; margin-bottom: 8px;">üîí</div>
                <div class="group-type-name" style="font-weight: 500;">Private</div>
              </div>
            </label>
          </div>
          <p id="settings-warning" style="color: #d13438; font-size: 12px; margin-top: 15px; display: none;">
            ‚ö†Ô∏è Switching to Private will invalidate all existing invite links.
          </p>
        </div>

        <div class="form-group" id="settings-password-section"
          style="margin-top: 20px; border-top: 1px solid #333; padding-top: 20px;">
          <label style="display:block; margin-bottom:10px; font-weight: 500;">Change Join Password (Admin Only)</label>
          <input type="password" id="settings-root-password" placeholder="Root Password"
            style="width:100%; padding:8px; background:#222; border:1px solid #333; color:#fff; margin-bottom: 10px; border-radius: 4px;">
          <input type="password" id="settings-new-password" placeholder="New Join Password"
            style="width:100%; padding:8px; background:#222; border:1px solid #333; color:#fff; border-radius: 4px;">
          <button class="modal-btn" id="btn-change-password"
            style="margin-top: 10px; width: 100%; background: #333;">Update Password</button>
          <div id="password-change-msg" style="margin-top: 5px; font-size: 12px;"></div>
        </div>

        <div id="settings-error"></div>
      </div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" id="btn-close-settings">Close</button>
        <button class="modal-btn modal-btn-confirm" id="btn-save-settings">Save</button>
      </div>
    </div>
  </div>

  <div class="chat-wrapper">
    <div class="groups-sidebar">
      <div class="groups-header">
        <button id="btn-back-groups" class="btn-back">‚Üê Back</button>
        <div class="groups-title">My Groups</div>
      </div>
      <div id="groups-list"></div>
    </div>

    <div class="chat-main">
      <div class="chat-header">
        <button id="btn-toggle-groups" class="input-button mobile-only" style="margin-right: 10px;">‚ò∞</button>
        <div class="chat-header-left" style="display: flex; align-items: center; gap: 10px; flex: 1;">
          {% if is_dm and opponent_username %}
          <img src="/user/profile-pic/{{ opponent_username }}" alt="Avatar"
            style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); flex-shrink: 0;">
          {% elif is_dm %}
          <img src="/static/unknown_user_phasma_icon.png" alt="Avatar"
            style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); flex-shrink: 0;">
          {% else %}
          <img id="header-group-avatar" src="/group/avatar/{{ group_id }}" alt="Avatar"
            style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); flex-shrink: 0;">
          {% endif %}
          <div style="flex: 1; min-width: 0;">
            <h3 id="group-name" style="margin: 0; font-size: 16px;">Loading...</h3>
            <div class="chat-user-badge" style="margin: 0; font-size: 12px;">Logged as:
              <span id="chat-user">...</span>
            </div>
          </div>
        </div>
        <button id="btn-toggle-members" class="input-button">üë•</button>
      </div>

      <div id="out">
        <div id="load-more-container">
          <button id="load-more-btn">‚Üì Load older messages</button>
        </div>
        <div id="messages-container"></div>
      </div>

      <div id="input-container">
        <div id="file-preview-container"></div>

        <div id="recording-container"
          style="display: none; align-items: center; background: #2b2b2b; padding: 10px; border-radius: 8px; flex: 1; margin-bottom: 10px;">
          <div class="recording-timer"
            style="flex: 1; display: flex; align-items: center; color: white; font-family: monospace; font-size: 16px;">
            <span style="color: #ff4b4b; margin-right: 10px; animation: pulse 1s infinite;">‚óè</span>
            <span id="recording-time">0:00,00</span>
          </div>
          <button id="btn-cancel-recording" class="input-button"
            style="color: #ff4b4b; margin-right: 10px; background: none; border: none; font-size: 20px; cursor: pointer;">üóëÔ∏è</button>
          <button id="btn-send-recording" class="input-button"
            style="color: #3BACFF; background: none; border: none; font-size: 24px; cursor: pointer;">‚û§</button>
        </div>

        <div class="input-row" id="input-row">
          <textarea id="in" rows="1" autocomplete="off" placeholder="Type a message..." inputmode="text"
            spellcheck="true"></textarea>
          <button type="button" class="input-button" id="btn-file-manager" title="File Manager">üìÅ</button>
          <button type="button" class="input-button" id="upload-btn">+</button>
          <button type="button" class="input-button" id="emoji-btn">üòÇ</button>
          <button type="button" class="input-button" id="btn-mic">üé§</button>
          <button type="button" class="input-button" id="send-btn">‚û§</button>
        </div>

        <input id="file-input" type="file" accept="image/*,video/*,audio/*,application/pdf,text/plain" multiple />
      </div>
    </div>

    <div class="members-sidebar">
      <div class="members-header">
        Members <span class="members-count" id="members-count">(0)</span>
        <div style="margin-left: auto; display: flex; gap: 5px;">
          <button id="btn-group-settings" class="input-button" style="display: none;" title="Group Settings">‚öôÔ∏è</button>
          <button id="invite-btn"
            style="display: none; background: #0078d4; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">
            Invite</button>
          <button id="leave-btn">Leave Group</button>
        </div>
      </div>
      <div id="members-list"></div>
    </div>
  </div>

  <div id="emoji-picker-modal" class="emoji-picker-modal">
    <div class="emoji-picker-container">
      <div class="emoji-picker-header">
        <input type="text" id="emoji-search" class="emoji-search" placeholder="Search emoji..." />
        <button type="button" class="emoji-close-btn" id="emoji-close-btn">x</button>
      </div>
      <div class="emoji-categories-tabs" id="emoji-categories-tabs">
        <!-- Categories will be injected here -->
      </div>
      <div class="emoji-picker-content">
        <div id="emoji-grid" class="emoji-grid"></div>
      </div>
      <!-- Variant Popup -->
      <div id="emoji-variant-popup" class="emoji-variant-popup" style="display: none;">
        <div class="emoji-variant-grid" id="emoji-variant-grid"></div>
      </div>
    </div>
  </div>
  <script nonce="{{ nonce }}">
    const GROUP_ID = {{ group_id| tojson }};
    const TEMPLATE_USER = {{ user| tojson }};
    const TEMPLATE_GROUP_TOKEN = {{ auth_token| tojson }};
    const GROUP_NAME = {{ group_name| tojson }};
    const GROUP_TYPE = {{ group_type| tojson }};
    const IS_DM = {{ is_dm| tojson }};
  </script>
  <div id="file-manager-modal" class="modal-overlay fm-modern-style">
    <div class="modal-dialog">
      <div class="fm-header">
        <button class="fm-btn-close" id="btn-close-fm">&times;</button>
        <div class="fm-title">Gallery</div>
        <button class="fm-btn-send" id="btn-fm-send" style="display: none;">Send</button>
      </div>

      <div class="fm-content">
        <!-- Gallery View -->
        <div id="fm-gallery-view" class="fm-view active">
          <div class="fm-grid" id="fm-gallery-grid">
            <div class="fm-grid-item fm-camera-slot" id="btn-fm-camera-direct">
              <span class="fm-icon">üì∑</span>
              <span>Camera</span>
            </div>
            <!-- Media items will be injected here -->
          </div>
          <div id="fm-empty-gallery" class="fm-empty-state" style="display: none;">
            <span class="fm-empty-icon">üñºÔ∏è</span>
            <button class="fm-main-btn" id="btn-fm-open-gallery">Open Gallery</button>
            <p>Select photos and videos to send</p>
          </div>
        </div>

        <!-- Files View -->
        <div id="fm-files-view" class="fm-view">
          <div class="fm-options-list">
            <button class="fm-option-item" id="btn-fm-system-direct">
              <span class="fm-option-icon">üìÇ</span>
              <span class="fm-option-text">System Files</span>
            </button>
          </div>
        </div>

        <!-- Camera View -->
        <div id="fm-camera-view" class="fm-view">
          <video id="fm-video-preview" autoplay playsinline muted></video>
          <div class="fm-camera-controls">
            <button class="fm-capture-btn" id="btn-fm-capture" title="Capture"></button>
            <button class="fm-stop-btn" id="btn-fm-stop">Cancel</button>
          </div>
        </div>
      </div>

      <div class="fm-bottom-bar">
        <button class="fm-tab-btn active" data-view="gallery">
          <span class="fm-tab-icon">üñºÔ∏è</span>
          <span class="fm-tab-label">Gallery</span>
        </button>
        <button class="fm-tab-btn" data-view="files">
          <span class="fm-tab-icon">üìé</span>
          <span class="fm-tab-label">File</span>
        </button>
      </div>
    </div>
  </div>

  <div id="media-viewer-modal" class="modal-overlay" style="background: rgba(0,0,0,0.95);">
    <div class="media-viewer-content"
      style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
      <button id="btn-close-viewer"
        style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: white; font-size: 30px; cursor: pointer; z-index: 100;">&times;</button>
      <div id="viewer-container"
        style="max-width: 95%; max-height: 95%; display: flex; align-items: center; justify-content: center;">
        <!-- Media will be injected here -->
      </div>
      <div id="viewer-caption"
        style="position: absolute; bottom: 20px; left: 0; width: 100%; text-align: center; color: white; background: rgba(0,0,0,0.5); padding: 10px;">
      </div>
    </div>
  </div>

  <audio id="notification-sound" src="/static/phasma_notification_sound.mp3" preload="auto"></audio>
  <script nonce="{{ nonce }}" src="/static/js/group_chat.js"></script>
</body>

</html>