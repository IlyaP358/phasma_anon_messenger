<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>phasma</title>
  <link rel="icon" type="image/png" href="/static/icon.png">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <style>
    body {
      max-width: 500px;
      margin: auto;
      padding: 0;
      background: black;
      color: #fff;
      font: 16px/1.6 menlo, monospace;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #out {
      flex: 1;
      display: flex;
      flex-direction: column-reverse;
      justify-content: flex-start;
      overflow-y: auto;
      padding: 1em;
      white-space: pre-wrap;
    }
    #input-container {
      padding: 1em;
      border-top: 1px solid #333;
      background: #111;
    }
    input {
      width: 95%;
      padding: 0.5em;
      font: inherit;
      background: #222;
      color: #fff;
      border: none;
      outline: none;
    }
    #upload-btn {
      width: 38%;
      margin-top: 0.5em;
      background: #222;
      color: #fff;
      border: none;
      padding: 0.5em;
      font: inherit;
      cursor: pointer;
    }
    #file-input {
      display: none;
    }
    .photo-msg {
      color: #0f0;
    }
    .photo-msg img {
      max-width: 300px;
      margin-top: 0.5em;
      border: 1px solid #0f0;
      cursor: pointer;
    }
    .photo-loading {
      color: #888;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="out"></div>

  <div id="input-container">
    <b>Hi, {{ user }}!</b><br>
    Message: <input id="in" autocomplete="off" />
    <button id="upload-btn">+ upload photo</button>
    <input id="file-input" type="file" accept="image/jpeg,image/png" />
  </div>

  <script nonce="{{ nonce }}">
    const USER = {{ user|tojson }};
    const AUTH_TOKEN = {{ auth_token|tojson }};
    const OLD_SESSION = {{ old_session|tojson }};

    if (OLD_SESSION) {
      alert("Your account was logged in from another device. Previous session closed.");
    }

    try {
      history.replaceState(null, '', '/');
    } catch (e) {
      // ignore
    }

    function checkSessionValidity() {
      fetch("/verify-session", {
        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
      }).then(response => {
        if (response.status === 401) {
          alert("Your session was closed from another device.");
          window.location.href = "/login";
        }
      }).catch(err => {
        console.log("Session check failed:", err);
      });
    }

    setInterval(checkSessionValidity, 10000);

    function sse() {
      const out = document.getElementById("out");
      
      fetch("/stream", {
        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
      }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        function read() {
          reader.read().then(({ done, value }) => {
            if (done) return;
            
            const text = decoder.decode(value, { stream: true });
            const lines = text.split('\n');
            
            lines.forEach(line => {
              if (line.startsWith('data: ')) {
                const data = line.slice(6);
                if (!data) return;
                
                // Check for photo with pre-signed URL: [PHOTO:ID:URL]
                const photoWithUrlMatch = data.match(/\[PHOTO:(\d+):([^\]]+)\]/);
                
                if (photoWithUrlMatch) {
                  const photoId = photoWithUrlMatch[1];
                  const photoUrl = photoWithUrlMatch[2];
                  
                  // Extract timestamp and username from message
                  const messageText = data.replace(/\[PHOTO:\d+:[^\]]+\]/, '').trim();
                  
                  // Create message div
                  const msgDiv = document.createElement("div");
                  msgDiv.classList.add("photo-msg");
                  msgDiv.setAttribute('data-photo-id', photoId);
                  
                  // Add timestamp/username text if exists
                  if (messageText) {
                    const textNode = document.createElement("div");
                    textNode.textContent = messageText;
                    msgDiv.appendChild(textNode);
                  }
                  
                  // Add image immediately (URL is already signed)
                  const img = document.createElement("img");
                  img.src = photoUrl;
                  img.alt = "Photo";
                  img.loading = "lazy";
                  msgDiv.appendChild(img);
                  
                  // Insert in correct position
                  out.prepend(msgDiv);
                  
                } else {
                  // Check for old format photo marker (fallback): [PHOTO:ID]
                  const photoMatch = data.match(/\[PHOTO:(\d+)\]/);
                  
                  if (photoMatch) {
                    const photoId = photoMatch[1];
                    
                    // Extract timestamp and username from message
                    const messageText = data.replace(/\[PHOTO:\d+\]/, '').trim();
                    
                    // Create placeholder immediately to preserve order
                    const msgDiv = document.createElement("div");
                    msgDiv.classList.add("photo-msg");
                    msgDiv.setAttribute('data-photo-id', photoId);
                    
                    // Add timestamp/username text if exists
                    if (messageText) {
                      const textNode = document.createElement("div");
                      textNode.textContent = messageText;
                      msgDiv.appendChild(textNode);
                    }
                    
                    // Add loading indicator
                    const loader = document.createElement("div");
                    loader.textContent = "[Loading photo...]";
                    loader.classList.add("photo-loading");
                    msgDiv.appendChild(loader);
                    
                    // Insert placeholder in correct position
                    out.prepend(msgDiv);
                    
                    // Request signed URL from server (fallback for old messages)
                    fetch(`/photo/sign/${photoId}`, {
                      headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` }
                    })
                    .then(response => response.json())
                    .then(data => {
                      // Remove loading indicator
                      loader.remove();
                      
                      // Create and add image
                      const img = document.createElement("img");
                      img.src = data.url;
                      img.alt = "Photo";
                      img.loading = "lazy";
                      msgDiv.appendChild(img);
                    })
                    .catch(err => {
                      console.error("Failed to load photo:", err);
                      loader.textContent = "[Failed to load photo]";
                      loader.style.color = "#f00";
                    });
                  } else {
                    // Regular text message
                    const msg = document.createElement("div");
                    msg.textContent = data;
                    out.prepend(msg);
                  }
                }
              }
            });
            read();
          });
        }
        read();
      });
    }

    $("#in").keyup(function (e) {
      if (e.keyCode === 13) {
        const text = $(this).val();
        $.ajax({
          url: "/post",
          type: "POST",
          headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
          data: { message: text },
          success: function() {
            // Message sent successfully
          },
          error: function(xhr) {
            if (xhr.status === 429) {
              try {
                const response = JSON.parse(xhr.responseText);
                alert(response.message || "You are sending requests too quickly. Please try again later.");
              } catch(e) {
                alert("You are sending requests too quickly. Please try again later.");
              }
            } else if (xhr.status === 401) {
              alert("Session expired. Please login again.");
              window.location.href = "/login";
            } else if (xhr.status === 400) {
              try {
                const response = JSON.parse(xhr.responseText);
                if (response.error === "Message too long") {
                  alert(`Message too long! Maximum length is ${response.max_length} characters.`);
                }
              } catch(e) {
                alert("Invalid request.");
              }
            }
          }
        });
        $(this).val("");
      }
    });

    $("#upload-btn").click(function () {
      $("#file-input").click();
    });

    $("#file-input").change(function () {
      const file = this.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append("file", file);

      $.ajax({
        url: "/upload",
        type: "POST",
        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
          console.log("Photo uploaded, ID:", response.photo_id);
          $("#file-input").val("");
        },
        error: function (err) {
          alert("Upload failed: " + err.responseText);
          $("#file-input").val("");
        }
      });
    });

    sse();

    // Improved logout with fetch + keepalive (works on tab close)
    window.addEventListener('beforeunload', function () {
      fetch('/logout', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${AUTH_TOKEN}` },
        keepalive: true
      });
    });
  </script>
</body>
</html>
